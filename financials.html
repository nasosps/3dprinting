<!DOCTYPE html>
<html lang="el">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Οικονομικά</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        ::-webkit-scrollbar {
            width: 6px
        }

        ::-webkit-scrollbar-track {
            background: #18181b
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 4px
        }
    </style>
</head>

<body class="bg-[#18181b] text-white min-h-screen font-sans pb-32">

    <div class="max-w-6xl mx-auto p-4 lg:pt-8 pt-20">
        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-emerald-500">Οικονομική Επισκόπηση</h1>
            <select id="yearFilter" onchange="loadStats()"
                class="bg-gray-800 text-white p-3 rounded-xl border border-gray-700 focus:border-emerald-500 outline-none shadow-sm">
                <option value="2026">2026</option>
                <option value="2025">2025</option>
                <option value="2024">2024</option>
            </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-[#27272a] p-6 rounded-3xl border border-gray-700 shadow-xl">
                <div class="text-sm text-gray-400 uppercase font-bold mb-2">ΣΥΝΟΛΙΚΑ ΕΣΟΔΑ</div>
                <div class="text-3xl font-extrabold text-emerald-400" id="totalRev">0.00€</div>
            </div>
            <div class="bg-[#27272a] p-6 rounded-3xl border border-gray-700 shadow-xl">
                <div class="text-sm text-gray-400 uppercase font-bold mb-2">ΚΑΘΑΡΟ ΚΕΡΔΟΣ</div>
                <div class="text-3xl font-extrabold text-green-500" id="totalProfit">0.00€</div>
            </div>
            <div class="bg-[#27272a] p-6 rounded-3xl border border-gray-700 shadow-xl">
                <div class="text-sm text-gray-400 uppercase font-bold mb-2">ΚΟΣΤΟΣ ΥΛΙΚΩΝ/ΡΕΥΜΑ</div>
                <div class="text-3xl font-extrabold text-red-400" id="totalCost">0.00€</div>
            </div>
            <div class="bg-[#27272a] p-6 rounded-3xl border border-gray-700 shadow-xl">
                <div class="text-sm text-gray-400 uppercase font-bold mb-2">ROI (Margin)</div>
                <div class="text-3xl font-extrabold text-yellow-500" id="avgMargin">0%</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-[#27272a] p-6 rounded-3xl border border-gray-700 shadow-xl lg:col-span-2">
                <h3 class="text-xl font-bold text-gray-300 mb-4">Έσοδα & Κέρδη ανά Μήνα</h3>
                <div class="h-80 w-full relative">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            <div class="bg-[#27272a] p-6 rounded-3xl border border-gray-700 shadow-xl">
                <h3 class="text-xl font-bold text-gray-300 mb-4">Κατανομή Κόστους</h3>
                <div class="h-64 w-full relative flex justify-center">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        renderSidebar('financials');

        let bChart = null;
        let pChart = null;

        async function loadStats() {
            const year = document.getElementById('yearFilter').value;

            // Get Orders (completed only for actual revenue?) - Let's use all 'completed' or 'active' for now? Usually financials track actual sales.
            // Let's assume all orders in 'orders' table are valid sales for now, but maybe filter by date.

            const startStr = `${year}-01-01`;
            const endStr = `${year}-12-31`;

            const { data: orders } = await sb.from('orders')
                .select('*')
                .gte('created_at', startStr)
                .lte('created_at', endStr);

            if (!orders) return;

            // Aggregates
            let tRev = 0, tCost = 0;
            const monthlyData = Array(12).fill(0).map(() => ({ rev: 0, cost: 0, profit: 0 }));

            orders.forEach(o => {
                const date = new Date(o.created_at);
                const mIdx = date.getMonth();
                const price = o.sale_price || 0;
                const cost = o.total_cost || 0;

                tRev += price;
                tCost += cost;

                monthlyData[mIdx].rev += price;
                monthlyData[mIdx].cost += cost;
                monthlyData[mIdx].profit += (price - cost);
            });

            const tProfit = tRev - tCost;
            const margin = tCost > 0 ? (tProfit / tCost) * 100 : 0;

            // UI Updates
            document.getElementById('totalRev').innerText = tRev.toFixed(2) + '€';
            document.getElementById('totalProfit').innerText = tProfit.toFixed(2) + '€';
            document.getElementById('totalCost').innerText = tCost.toFixed(2) + '€';
            document.getElementById('avgMargin').innerText = Math.round(margin) + '%';
            document.getElementById('avgMargin').className = margin >= 0 ? "text-3xl font-extrabold text-yellow-500" : "text-3xl font-extrabold text-red-500";

            // Charts
            renderCharts(monthlyData, tRev, tCost);
        }

        function renderCharts(mData, totalRev, totalCost) {
            const ctxBar = document.getElementById('barChart').getContext('2d');
            const ctxPie = document.getElementById('pieChart').getContext('2d');

            if (bChart) bChart.destroy();
            if (pChart) pChart.destroy();

            // Bar Chart
            bChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [
                        { label: 'Έσοδα (€)', data: mData.map(d => d.rev), backgroundColor: '#10b981', borderRadius: 6 },
                        { label: 'Κόστος (€)', data: mData.map(d => d.cost), backgroundColor: '#ef4444', borderRadius: 6 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: { color: '#3f3f46' }, ticks: { color: '#9ca3af' } }, x: { grid: { display: false }, ticks: { color: '#9ca3af' } } },
                    plugins: { legend: { labels: { color: '#d1d5db' } } }
                }
            });

            // Pie Chart (Profit vs Cost approx)
            pChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Κέρδος', 'Κόστος'],
                    datasets: [{
                        data: [totalRev - totalCost, totalCost],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#d1d5db' } } }
                }
            });
        }

        // Set current year and load
        document.getElementById('yearFilter').value = new Date().getFullYear();
        setTimeout(loadStats, 500);

    </script>
</body>

</html>