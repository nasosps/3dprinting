<!DOCTYPE html>
<html lang="el">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ŒúŒøŒΩœÑŒ≠ŒªŒ± (Presets) - 3D Printing Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#18181b">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #18181b;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-[#09090b] text-white font-sans antialiased pb-20 pt-24">

    <!-- Back Button - Universal Position -->
    <a href="index.html"
        class="fixed top-4 left-4 z-50 bg-gray-800/90 p-3 rounded-full text-white hover:bg-gray-700 transition shadow-lg backdrop-blur-md border border-gray-700">
        <i class="fas fa-arrow-left"></i>
    </a>

    <!-- Header -->
    <header
        class="fixed top-0 left-0 right-0 bg-black/90 backdrop-blur-md z-40 p-4 border-b border-gray-800 transition-all duration-300">
        <div class="max-w-7xl mx-auto pl-16 flex justify-between items-center"> <!-- Added pl-16 for back button -->
            <h1 class="text-2xl font-black tracking-tight text-white truncate">Presets <span
                    class="text-purple-500 hidden sm:inline">Manager</span></h1>
            <div class="flex gap-2">
                <button onclick="openModal()"
                    class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-xl font-bold shadow-lg shadow-purple-900/40 transition text-sm flex items-center gap-2">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">ŒùŒ≠Œø</span>
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div id="modelsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Models injected here... -->
        </div>
    </div>

    <!-- ADVANCED PRESET MODAL -->
    <div id="modelModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-start justify-center overflow-y-auto">
        <div
            class="w-full min-h-screen sm:min-h-0 sm:max-w-xl sm:my-10 bg-[#18181b] sm:rounded-2xl sm:border border-gray-700 shadow-2xl flex flex-col relative">

            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-[#202022] sm:rounded-t-2xl">
                <h3 class="text-xl font-bold text-purple-400" id="modalTitle">ŒùŒ≠Œø Preset</h3>
                <button onclick="closeModal()"
                    class="bg-gray-800 w-10 h-10 rounded-full text-gray-400 hover:text-white flex items-center justify-center border border-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 space-y-6 pb-24">
                <input type="hidden" id="modelId">

                <!-- Name -->
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1 mb-1 block tracking-wider">ŒüŒΩŒøŒºŒ±
                        ŒúŒøŒΩœÑŒµŒªŒøœÖ</label>
                    <input type="text" id="name"
                        class="w-full p-3 rounded-xl bg-[#27272a] border border-gray-600 text-white text-lg font-bold outline-none focus:border-purple-500 shadow-sm"
                        placeholder="œÄ.œá. Flexi Rex" required>
                </div>

                <!-- MATERIALS SECTION -->
                <div class="bg-gray-800/30 p-4 rounded-2xl border border-purple-900/30">
                    <div
                        class="text-xs text-purple-400 font-bold mb-3 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-fill-drip"></i> Œ•ŒªŒπŒ∫Œ± (Multi-Color)
                    </div>

                    <div class="grid grid-cols-1 gap-3 mb-3 relative">
                        <div class="relative">
                            <input type="text" id="materialSearch"
                                class="w-full p-3 rounded-xl bg-[#27272a] border border-gray-600 text-white text-sm focus:border-purple-500 outline-none shadow-inner"
                                placeholder="üîç ŒëŒΩŒ±Œ∂ŒÆœÑŒ∑œÉŒ∑..." onkeyup="filterMaterialList()"
                                onfocus="filterMaterialList()">
                            <div id="materialDropdown"
                                class="hidden absolute z-50 w-full bg-[#27272a] border border-gray-600 rounded-lg max-h-48 overflow-y-auto shadow-xl mt-1">
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 items-center bg-[#27272a] p-3 rounded-xl border border-gray-600 shadow-lg">
                        <div id="selectedMatInfo"
                            class="flex-grow text-sm text-gray-300 italic px-2 font-medium truncate">--</div>
                        <input type="number" id="addMatGrams" placeholder="Gr"
                            class="w-20 p-2 rounded-lg bg-gray-900 text-lg text-center border border-gray-500 text-white font-bold outline-none focus:border-purple-500">
                        <button onclick="addMaterialRow()"
                            class="bg-purple-600 w-10 h-10 rounded-lg text-white hover:bg-purple-500 shadow-lg flex items-center justify-center"><i
                                class="fas fa-plus"></i></button>
                    </div>

                    <div id="usedMatsList" class="mt-3 space-y-2"></div>
                </div>

                <!-- BATCH & EXTRAS -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800/30 p-4 rounded-2xl border border-gray-600/30">
                        <label class="text-xs text-gray-400 block mb-2 font-bold uppercase">Extras</label>
                        <div class="flex gap-2">
                            <select id="addExtSel"
                                class="w-full p-2 rounded-lg bg-[#27272a] border border-gray-600 text-xs"></select>
                            <button onclick="addExtraRow()" class="bg-indigo-600 px-3 rounded-lg"><i
                                    class="fas fa-plus"></i></button>
                        </div>
                        <div id="usedExtList" class="mt-2 space-y-1"></div>
                    </div>

                    <div class="bg-gray-800/30 p-4 rounded-2xl border border-gray-600/30">
                        <label class="text-xs text-gray-400 block mb-2 font-bold uppercase">ŒïŒ∫œÑœçœÄœâœÉŒ∑ (Batch)</label>
                        <div class="grid grid-cols-2 gap-2 text-center">
                            <div>
                                <div class="text-[10px] text-gray-500">TEM/BATCH</div><input type="number" id="batchPcs"
                                    value="1" class="w-full bg-[#27272a] border border-gray-600 text-center rounded p-1"
                                    oninput="recalc()">
                            </div>
                            <div>
                                <div class="text-[10px] text-gray-500">MINS</div><input type="number" id="bMins"
                                    value="0" class="w-full bg-[#27272a] border border-gray-600 text-center rounded p-1"
                                    oninput="recalc()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RESULTS / PRICE -->
                <div class="bg-[#202022] p-5 rounded-3xl border border-gray-600 shadow-2xl space-y-4">
                    <div class="flex justify-between items-center bg-gray-900/50 p-3 rounded-xl border border-gray-700">
                        <div class="text-xs text-gray-500 font-bold uppercase">Unit Specs</div>
                        <div class="text-right text-sm font-mono text-gray-300">
                            <span id="resUnitGrams">0</span>g | <span id="resUnitMins">0</span>m
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 items-center">
                        <div>
                            <label class="text-xs text-gray-500 font-bold uppercase block mb-1">Unit Cost (‚Ç¨)</label>
                            <div class="text-xl font-bold text-gray-400" id="resUnitCost">0.00</div>
                        </div>
                        <div>
                            <label class="text-xs text-purple-400 font-bold uppercase block mb-1">Unit Price (‚Ç¨)</label>
                            <input type="number" id="unitPrice" step="0.01"
                                class="w-full p-3 bg-[#18181b] border border-purple-500 text-center text-white font-bold rounded-xl text-2xl"
                                oninput="recalc(true)"> <!-- Manual Override -->
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="saveModel()"
                        class="flex-1 bg-purple-600 py-4 rounded-xl font-bold hover:bg-purple-500 transition shadow-xl text-lg text-white uppercase tracking-wider">
                        <i class="fas fa-save mr-2"></i> ŒëœÄŒøŒ∏Œ∑Œ∫ŒµœÖœÉŒ∑
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let mats = [], extras = [], currentMats = [], currentExtras = [], selectedSpool = null;

        renderSidebar('models');
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const [m, e] = await Promise.all([
                sb.from('materials').select('*'),
                sb.from('accessories').select('*')
            ]);
            mats = m.data || [];
            extras = e.data || [];

            const matSel = document.getElementById('addExtSel'); matSel.innerHTML = "";
            extras.forEach(x => matSel.innerHTML += `<option value="${x.id}">${x.name} (${x.cost}‚Ç¨)</option>`);

            loadModels();
        }

        async function loadModels() {
            const list = document.getElementById('modelsList');
            const { data: models, error } = await sb.from('print_models').select('*');
            if (error) return console.error(error);

            list.innerHTML = models.map(m => {
                // Formatting
                const matCount = (Array.isArray(m.materials) ? m.materials.length : (m.material_id ? 1 : 0));

                return `
                <div class="bg-[#18181b] p-6 rounded-3xl border border-gray-800 hover:border-purple-500/50 transition duration-300 group relative">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-white group-hover:text-purple-400 transition truncate pr-4">${m.name}</h3>
                        <span class="bg-purple-900/30 text-purple-300 px-3 py-1 rounded-lg text-sm font-bold min-w-[60px] text-center">${m.unit_price}‚Ç¨</span>
                    </div>
                    <div class="space-y-2 text-sm text-gray-400">
                         <div class="flex justify-between border-b border-gray-800 pb-2">
                             <span>Œ•ŒªŒπŒ∫Œ¨:</span> <span class="text-white">${matCount} Colors</span>
                        </div>
                        <div class="flex justify-between border-b border-gray-800 pb-2">
                             <span>Specs (Unit):</span> <span class="text-white">${Math.round(m.weight_g || 0)}g / ${m.print_time_hours || 0}h</span>
                        </div>
                         <div class="flex justify-between pt-1">
                             <span>Batch:</span> <span class="text-white">${m.batch_pcs || 1} pcs</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 flex gap-2">
                        <button onclick="editModel('${m.id}')" class="flex-1 bg-gray-800 hover:bg-gray-700 py-2 rounded-xl font-bold text-gray-300"><i class="fas fa-edit mr-2"></i>Edit</button>
                        <button onclick="deleteRow('print_models', '${m.id}', loadModels)" class="w-12 bg-red-900/20 hover:bg-red-900/50 text-red-500 rounded-xl"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- CALCS & UI ---

        function filterMaterialList() {
            const val = document.getElementById('materialSearch').value.toUpperCase();
            const dd = document.getElementById('materialDropdown');
            dd.innerHTML = ""; dd.classList.remove('hidden');
            const matches = mats.filter(m => (m.brand + m.type + m.color).toUpperCase().includes(val) || m.name?.toUpperCase().includes(val));
            const unique = {};
            matches.forEach(m => {
                const k = `${m.brand} ${m.type} ${m.color}`;
                // Logic: Prefer lowest weight > 0 (Active Spool)
                if (!unique[k]) {
                    unique[k] = m;
                } else {
                    const uw = unique[k].current_weight;
                    const mw = m.current_weight;
                    // If new is positive AND (current is empty OR new is less than current)
                    if (mw > 0 && (uw <= 0 || mw < uw)) {
                        unique[k] = m;
                    }
                }
            });
            Object.values(unique).forEach(m => {
                const d = document.createElement('div');
                d.className = "p-3 border-b border-gray-600 hover:bg-gray-700 cursor-pointer flex justify-between";
                d.innerHTML = `<span>${m.color} <span class="text-xs text-gray-400">${m.brand} ${m.type}</span></span> <span class="text-purple-400 font-bold">${Math.round(m.current_weight)}g</span>`;
                d.onclick = () => { selectMaterial(m); };
                dd.appendChild(d);
            });
            if (!matches.length) dd.innerHTML = '<div class="p-2 text-gray-500 text-center text-xs">??</div>';
        }
        function selectMaterial(m) {
            selectedSpool = m;
            document.getElementById('selectedMatInfo').innerText = `${m.brand} ${m.type} ${m.color}`;
            document.getElementById('materialDropdown').classList.add('hidden');
            document.getElementById('materialSearch').value = "";
        }
        function addMaterialRow() {
            if (!selectedSpool) return;
            const g = parseFloat(document.getElementById('addMatGrams').value); if (!g) return;
            currentMats.push({ id: selectedSpool.id, name: selectedSpool.name, price: selectedSpool.price, grams: g });
            document.getElementById('addMatGrams').value = ""; selectedSpool = null; document.getElementById('selectedMatInfo').innerText = "--";
            renderRows();
        }
        function addExtraRow() {
            const id = document.getElementById('addExtSel').value;
            const e = extras.find(x => x.id === id); if (e) currentExtras.push({ id: e.id, name: e.name, cost: e.cost });
            renderRows();
        }
        function renderRows() {
            const ml = document.getElementById('usedMatsList'); ml.innerHTML = "";
            currentMats.forEach((m, i) => ml.innerHTML += `<div class="flex justify-between items-center bg-[#18181b] p-2 rounded border border-gray-700 text-sm"><span class="text-gray-300">${m.name || 'M'} (${m.grams}g)</span><i onclick="currentMats.splice(${i},1);renderRows()" class="fas fa-times text-red-500 cursor-pointer"></i></div>`);
            const el = document.getElementById('usedExtList'); el.innerHTML = "";
            currentExtras.forEach((e, i) => el.innerHTML += `<div class="flex justify-between items-center bg-[#18181b] p-2 rounded border border-gray-700 text-sm"><span class="text-gray-300">${e.name} (${e.cost}‚Ç¨)</span><i onclick="currentExtras.splice(${i},1);renderRows()" class="fas fa-times text-red-500 cursor-pointer"></i></div>`);
            recalc();
        }

        function recalc(manualPrice = false) {
            const bPcs = parseFloat(document.getElementById('batchPcs').value) || 1;
            const bMins = parseFloat(document.getElementById('bMins').value) || 0;

            let totalBatchGrams = 0;
            let batchMatCost = 0;
            currentMats.forEach(m => {
                totalBatchGrams += m.grams;
                // Assuming avg price 20/kg if specific price missing?
                const pricePerG = (m.price || 20) / 1000;
                batchMatCost += m.grams * pricePerG;
            });

            let batchExtraCost = 0;
            currentExtras.forEach(e => batchExtraCost += e.cost);

            // Unit calcs
            const unitGrams = totalBatchGrams / bPcs;
            const unitMins = bMins / bPcs;

            // Costs
            const unitMatCost = batchMatCost / bPcs;
            const unitExtraCost = batchExtraCost; // Extras usually per unit? Or per batch? 
            // In Quotes, we added extras per unit functionality. 
            // Let's assume extras are added PER UNIT in the logic context (like magnets per piece).
            // If we assume "Batch setup", usually extras are proportional to count.
            // If I add 10 magnets for a batch of 10, it's 1 magnet per unit. 
            // Logic in Orders: Extras were array. 
            // Let's assume Extras inserted are TOTAL for the BATCH (if thinking in batch mode) or PER UNIT?
            // In Quotes, we had "Batch Count". 
            // Simpler: Extras list is "What goes into the print job". 
            // If batch is 10 items, and I add "Screw x10", then costs are correct.
            // So I treat expenses as "Per Batch".
            // Unit Cost = (BatchMat + BatchExtra + Power) / Pcs ??
            // Power is calculated on Time. Time is Batch Time.

            const powerCost = (unitMins / 60) * 0.75; // 0.75‚Ç¨/h * unit hours

            // Wait: unitMins is BatchMins / Pcs. Correct.

            // Extra Cost Per Unit:
            const unitExtra = batchExtraCost / bPcs;

            const totalUnitCost = unitMatCost + unitExtra + powerCost;

            document.getElementById('resUnitGrams').innerText = unitGrams.toFixed(1);
            document.getElementById('resUnitMins').innerText = unitMins.toFixed(1);
            document.getElementById('resUnitCost').innerText = totalUnitCost.toFixed(2);

            if (!manualPrice) {
                // Auto Suggested Price: Cost * 2.5
                document.getElementById('unitPrice').value = (totalUnitCost * 2.5).toFixed(2);
            }
        }

        // --- SUBMIT --- 

        async function saveModel() {
            const id = document.getElementById('modelId').value;
            const name = document.getElementById('name').value;
            if (!name) return showToast("BŒ¨ŒªŒµ œåŒΩŒøŒºŒ±!", 'error');

            const bPcs = parseFloat(document.getElementById('batchPcs').value) || 1;
            const uGrams = parseFloat(document.getElementById('resUnitGrams').innerText) || 0;
            const uMins = parseFloat(document.getElementById('resUnitMins').innerText) || 0;
            const uPrice = parseFloat(document.getElementById('unitPrice').value) || 0;

            const data = {
                name: name,
                weight_g: uGrams,
                print_time_hours: (uMins / 60).toFixed(2),
                unit_price: uPrice,
                materials: currentMats, // JSON
                extras: currentExtras,  // JSON
                batch_pcs: bPcs,
                batch_mins: parseFloat(document.getElementById('bMins').value) || 0
            };

            try {
                if (id) await sb.from('print_models').update(data).eq('id', id);
                else await sb.from('print_models').insert(data);

                closeModal(); loadModels(); showToast("ŒëœÄŒøŒ∏Œ∑Œ∫ŒµœçœÑŒ∑Œ∫Œµ");
            } catch (e) { showToast(e.message, 'error'); }
        }

        async function editModel(id) {
            const { data: m } = await sb.from('print_models').select('*').eq('id', id).single();
            if (!m) return;

            document.getElementById('modelId').value = m.id;
            document.getElementById('name').value = m.name;
            document.getElementById('batchPcs').value = m.batch_pcs || 1;
            document.getElementById('bMins').value = m.batch_mins || (m.print_time_hours * 60) || 0;
            document.getElementById('unitPrice').value = m.unit_price;

            // Materials
            if (Array.isArray(m.materials)) {
                currentMats = m.materials;
            } else if (m.material_id) {
                // Fallback
                currentMats = [{ id: m.material_id, name: 'Default', grams: m.weight_g || 0, price: 20 }];
            } else {
                currentMats = [];
            }

            currentExtras = Array.isArray(m.extras) ? m.extras : [];

            renderRows();
            openModal();
        }

        function openModal() { document.getElementById('modelModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modelModal').classList.add('hidden'); }

        document.addEventListener('click', (e) => {
            if (!document.getElementById('materialDropdown').contains(e.target) && e.target.id !== 'materialSearch')
                document.getElementById('materialDropdown').classList.add('hidden');
        });

    </script>
</body>

</html>