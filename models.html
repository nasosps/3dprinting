<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <title>ÎœÎ¿Î½Ï„Î­Î»Î± (Master Presets)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#18181b}::-webkit-scrollbar-thumb{background:#3f3f46;border-radius:4px}</style>
</head>
<body class="bg-[#18181b] text-white min-h-screen p-4 font-sans">
    <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-6 border-b border-gray-700 pb-4">
            <div class="flex items-center gap-4">
                <a href="index.html" class="bg-gray-800 w-10 h-10 rounded-full flex justify-center items-center hover:bg-gray-700"><i class="fas fa-arrow-left"></i></a>
                <h1 class="text-2xl font-bold text-purple-500">Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎ· Presets</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="openNewModel()" class="bg-purple-600 px-4 py-2 rounded font-bold hover:bg-purple-500 text-sm shadow-lg"><i class="fas fa-plus mr-2"></i>ÎÎ­Î¿ ÎœÎ¿Î½Ï„Î­Î»Î¿</button>
                <a href="quotes.html" class="bg-teal-600 px-4 py-2 rounded font-bold hover:bg-teal-500 text-sm"><i class="fas fa-file-invoice mr-2"></i>Î ÏÎ¿ÏƒÏ†Î¿ÏÎ­Ï‚</a>
            </div>
        </div>

        <input type="text" id="searchInput" onkeyup="filterModels()" placeholder="ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..." class="w-full p-3 rounded-xl bg-[#27272a] border border-gray-700 text-white outline-none focus:border-purple-500 mb-6">

        <div id="modelsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="col-span-3 text-center text-gray-500 py-10 animate-pulse">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>
        </div>
    </div>

    <div id="modelModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-2 backdrop-blur-sm">
        <div class="bg-[#27272a] p-5 rounded-2xl w-full max-w-lg border border-gray-700 max-h-[95vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-purple-400" id="modalTitle">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎœÎ¿Î½Ï„Î­Î»Î¿Ï…</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <input type="hidden" id="editId">
            <div class="space-y-4">
                
                <div>
                    <label class="text-[10px] text-gray-400 uppercase font-bold ml-1">ÎŸÎ½Î¿Î¼Î± ÎœÎ¿Î½Ï„ÎµÎ»Î¿Ï…</label>
                    <input type="text" id="inpName" class="w-full p-2 rounded bg-[#202022] border border-gray-600 outline-none focus:border-purple-500 text-white" placeholder="Î .Ï‡. Cart QR">
                </div>

                <div class="bg-gray-800 p-3 rounded-xl border border-teal-900/30">
                    <div class="text-[10px] text-teal-500 font-bold mb-2 uppercase">Î£Ï…Î½Ï„Î±Î³Î· Î¥Î»Î¹ÎºÏ‰Î½ (Î§Ï„Î¹ÏƒÎ¹Î¼Î¿)</div>
                    
                    <div class="grid grid-cols-3 gap-1 mb-2">
                        <select id="filterBrand" class="w-full p-1 rounded bg-gray-900 text-xs border border-gray-600 text-gray-300 outline-none" onchange="updateMatFilters('brand')"><option value="">ÎœÎ¬ÏÎºÎ±</option></select>
                        <select id="filterType" class="w-full p-1 rounded bg-gray-900 text-xs border border-gray-600 text-gray-300 outline-none" onchange="updateMatFilters('type')"><option value="">Î•Î¯Î´Î¿Ï‚</option></select>
                        <select id="filterColor" class="w-full p-1 rounded bg-gray-900 text-xs border border-gray-600 text-gray-300 outline-none" onchange="updateMatFilters('color')"><option value="">Î§ÏÏÎ¼Î±</option></select>
                    </div>

                    <div class="flex gap-2 mb-2">
                        <div id="selectedMatInfo" class="flex-grow text-[10px] text-gray-400 flex items-center px-2 border border-gray-700 rounded bg-gray-900 italic">-- Î•Ï€Î¯Î»ÎµÎ¾Îµ --</div>
                        <input type="number" id="addMatGrams" placeholder="g" class="w-16 p-1 rounded bg-gray-900 text-xs text-center border border-gray-600 outline-none text-white">
                        <button onclick="addMaterialRow()" class="bg-teal-600 px-3 rounded text-xs font-bold text-white hover:bg-teal-500 transition">+</button>
                    </div>

                    <div id="recipeList" class="space-y-1 max-h-32 overflow-y-auto pr-1"></div>
                </div>

                <div class="bg-gray-800 p-3 rounded-xl border border-gray-600 shadow-inner">
                    <div class="text-[10px] font-bold text-purple-500 uppercase mb-2">Batch Info (Î Î±ÏÎ±Î³Ï‰Î³Î·)</div>
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <div>
                            <label class="text-[9px] text-gray-500 block text-center">Î¤Î•Îœ/Î Î›Î‘Î¤ÎŸ</label>
                            <input type="number" id="batchPcs" class="w-full p-1 bg-gray-900 border border-gray-600 text-center text-sm rounded text-white font-bold focus:border-purple-500 outline-none" oninput="calcUnit()">
                        </div>
                        <div>
                            <label class="text-[9px] text-gray-500 block text-center">Î£Î¥Î. GR</label>
                            <input type="number" id="bGrams" readonly class="w-full p-1 bg-gray-700 border border-gray-600 text-center text-sm rounded text-gray-300 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="text-[9px] text-gray-500 block text-center">Î£Î¥Î. MIN</label>
                            <input type="number" id="bMins" class="w-full p-1 bg-gray-900 border border-gray-600 text-center text-sm rounded text-white focus:border-purple-500 outline-none" oninput="calcUnit()">
                        </div>
                    </div>
                    <div class="text-center text-xs text-gray-400 bg-gray-900/50 rounded py-1 border border-gray-700 border-dashed">
                        Î‘Î½Î¬ Ï„ÎµÎ¼Î¬Ï‡Î¹Î¿: <span id="resGrams" class="text-white font-bold">0</span>g | <span id="resMins" class="text-white font-bold">0</span>min
                    </div>
                </div>

                <div>
                    <label class="text-[10px] text-green-500 font-bold uppercase ml-1">Î¤Î¹Î¼Î· ÎœÎ¿Î½Î±Î´Î±Ï‚ (â‚¬)</label>
                    <input type="number" id="inpPrice" class="w-full p-2 bg-gray-900 border border-green-600 rounded text-center text-white font-bold text-lg outline-none focus:ring-1 ring-green-500" placeholder="0.00">
                </div>

                <button onclick="saveModel()" class="w-full bg-purple-600 p-3 rounded-xl font-bold hover:bg-purple-500 shadow-lg text-white mt-2">Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î£Î—</button>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let allModels = [];
        let mats = []; 
        let currentRecipe = []; // Stores the materials for the current modal
        let selectedSpool = null;

        // INIT
        setTimeout(() => {
            // Load Materials for Filters
            db.collection('materials').orderBy('name').onSnapshot(snap => { 
                mats=[]; 
                snap.forEach(d=>{ const m=d.data(); mats.push({...m, id:d.id}); });
                populateFilters(); 
            });

            // Load Models List
            db.collection('print_models').orderBy('name').onSnapshot(snap => {
                const list = document.getElementById('modelsList'); list.innerHTML = ""; allModels = [];
                if (snap.empty) { list.innerHTML = `<div class="col-span-3 text-center text-gray-500">Empty</div>`; return; }

                snap.forEach(doc => {
                    const m = doc.data(); m.id = doc.id; allModels.push(m); renderCard(m, list);
                });
            });
        }, 1000);

        // --- RENDER CARDS ---
        function renderCard(m, container) {
            let matsHtml = '';
            if (m.materials && m.materials.length > 0) {
                matsHtml = '<div class="mt-2 space-y-1 bg-gray-900/50 p-2 rounded border border-gray-700">';
                m.materials.forEach(mat => { matsHtml += `<div class="flex justify-between items-center text-[10px]"><span class="text-gray-300 truncate w-2/3">${mat.name}</span><span class="text-yellow-500 font-bold ml-2">${mat.grams}g</span></div>`; });
                matsHtml += '</div>';
            } else { matsHtml = `<div class="text-[10px] text-gray-600 mt-2 italic p-2">Î§Ï‰ÏÎ¯Ï‚ ÏƒÏ…Î½Ï„Î±Î³Î®.</div>`; }

            // Safe JSON stringify for edit button
            // We store the ID in data attribute to avoid JSON quote escaping hell, 
            // but for simplicity here we use a global lookup or ID pass.
            // Let's pass the ID and find the object in allModels array.
            
            container.innerHTML += `
            <div class="bg-[#27272a] p-4 rounded-xl border border-gray-700 shadow-lg relative group hover:border-purple-500/50 transition flex flex-col justify-between">
                <div>
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-white truncate w-5/6">${m.name}</h3>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                            <button onclick="openEditModel('${m.id}')" class="text-blue-400 hover:text-white bg-gray-800 p-1 rounded"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteDoc('print_models', '${m.id}')" class="text-red-500 hover:text-white bg-gray-800 p-1 rounded"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2 text-center">
                        <div class="bg-gray-800 p-1.5 rounded border border-gray-600"><div class="text-[9px] text-gray-400 uppercase">BATCH</div><div class="text-sm font-bold text-white">${m.batchPcs||1} Ï„Î¼Ï‡</div></div>
                        <div class="bg-gray-800 p-1.5 rounded border border-gray-600"><div class="text-[9px] text-gray-400 uppercase">TIMH MON.</div><div class="text-lg font-bold text-green-400">${m.unitPrice||'0.00'}â‚¬</div></div>
                    </div>
                    <div class="mt-3"><div class="text-[9px] text-gray-500 uppercase font-bold">Î£Î¥ÎÎ¤Î‘Î“Î—</div>${matsHtml}</div>
                </div>
            </div>`;
        }

        // --- FILTER & MATERIAL LOGIC ---
        function populateFilters() {
            const brands = [...new Set(mats.map(m => m.brand || 'Other'))].sort();
            const el = document.getElementById('filterBrand'); el.innerHTML = '<option value="">ÎœÎ¬ÏÎºÎ±</option>';
            brands.forEach(b => el.innerHTML += `<option value="${b}">${b}</option>`);
            updateMatFilters('brand');
        }
        function updateMatFilters(changed) {
            const brand = document.getElementById('filterBrand').value;
            const type = document.getElementById('filterType').value;
            if (changed === 'brand') {
                const types = [...new Set(mats.filter(m => !brand || m.brand == brand).map(m => m.type || 'Standard'))].sort();
                const elType = document.getElementById('filterType'); elType.innerHTML = '<option value="">Î•Î¯Î´Î¿Ï‚</option>';
                types.forEach(t => elType.innerHTML += `<option value="${t}">${t}</option>`);
                document.getElementById('filterColor').innerHTML = '<option value="">Î§ÏÏÎ¼Î±</option>';
            }
            if (changed === 'brand' || changed === 'type') {
                const colors = mats.filter(m => (!brand || m.brand == brand) && (!type || m.type == type));
                const elColor = document.getElementById('filterColor'); elColor.innerHTML = '<option value="">Î§ÏÏÎ¼Î±</option>';
                colors.forEach(m => elColor.innerHTML += `<option value="${m.color}" data-id="${m.id}">${m.color} (${m.price}â‚¬)</option>`);
            }
            if (changed === 'color') {
                const sel = document.getElementById('filterColor'); const id = sel.options[sel.selectedIndex].getAttribute('data-id');
                if (id) { selectedSpool = mats.find(m => m.id === id); document.getElementById('selectedMatInfo').innerText = `${selectedSpool.name}`; } 
                else { selectedSpool = null; document.getElementById('selectedMatInfo').innerText = "--"; }
            }
        }

        function addMaterialRow() {
            if(!selectedSpool) return alert("Î•Ï€Î¯Î»ÎµÎ¾Îµ Ï…Î»Î¹ÎºÏŒ!");
            const g = parseFloat(document.getElementById('addMatGrams').value);
            if(!g) return alert("Î’Î¬Î»Îµ Î³ÏÎ±Î¼Î¼Î¬ÏÎ¹Î±!");
            
            currentRecipe.push({ id: selectedSpool.id, name: selectedSpool.name, price: selectedSpool.price, grams: g });
            renderRecipe(); document.getElementById('addMatGrams').value="";
        }

        function renderRecipe() {
            const list = document.getElementById('recipeList');
            list.innerHTML = currentRecipe.map((m,i)=>`
                <div class="flex justify-between items-center text-xs bg-gray-900 p-1 rounded border border-gray-700 mb-1">
                    <span class="text-yellow-100 truncate w-3/4">${m.name}</span>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">${m.grams}g</span>
                        <button onclick="currentRecipe.splice(${i},1);renderRecipe()" class="text-red-400 hover:text-red-200">x</button>
                    </div>
                </div>`).join('');
            
            // Auto Sum Grams
            let totalGrams = 0;
            currentRecipe.forEach(m => totalGrams += (parseFloat(m.grams)||0));
            document.getElementById('bGrams').value = totalGrams; 
            calcUnit();
        }

        function calcUnit() {
            const p = parseFloat(document.getElementById('batchPcs').value) || 1;
            const g = parseFloat(document.getElementById('bGrams').value) || 0;
            const m = parseFloat(document.getElementById('bMins').value) || 0;
            document.getElementById('resGrams').innerText = (g/p).toFixed(2);
            document.getElementById('resMins').innerText = (m/p).toFixed(2);
        }

        // --- MODAL ACTIONS ---
        function openNewModel() {
            document.getElementById('editId').value = "";
            document.getElementById('modalTitle').innerText = "ÎÎ­Î¿ ÎœÎ¿Î½Ï„Î­Î»Î¿";
            document.getElementById('inpName').value = "";
            document.getElementById('batchPcs').value = "1";
            document.getElementById('bGrams').value = "0";
            document.getElementById('bMins').value = "0";
            document.getElementById('inpPrice').value = "";
            currentRecipe = [];
            renderRecipe(); populateFilters();
            document.getElementById('modelModal').classList.remove('hidden');
        }

        function openEditModel(id) {
            const m = allModels.find(x => x.id === id);
            if(!m) return;

            document.getElementById('editId').value = m.id;
            document.getElementById('modalTitle').innerText = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±: " + m.name;
            document.getElementById('inpName').value = m.name;
            document.getElementById('batchPcs').value = m.batchPcs || 1;
            document.getElementById('bGrams').value = m.batchGrams || 0;
            document.getElementById('bMins').value = m.batchMins || 0;
            document.getElementById('inpPrice').value = m.unitPrice || "";
            
            // Deep copy recipe
            currentRecipe = [];
            if(m.materials && Array.isArray(m.materials)) {
                currentRecipe = JSON.parse(JSON.stringify(m.materials));
            }
            renderRecipe(); populateFilters();
            document.getElementById('modelModal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modelModal').classList.add('hidden'); }

        function saveModel() {
            const id = document.getElementById('editId').value;
            const name = document.getElementById('inpName').value;
            const bPcs = parseFloat(document.getElementById('batchPcs').value);
            const bGrams = parseFloat(document.getElementById('bGrams').value);
            const bMins = parseFloat(document.getElementById('bMins').value);
            const price = parseFloat(document.getElementById('inpPrice').value);

            if(!name || !bGrams) return alert("Missing Info (Name/Materials)");

            const data = {
                name: name,
                batchPcs: bPcs, batchGrams: bGrams, batchMins: bMins,
                grams: bGrams / bPcs, minutes: bMins / bPcs,
                unitPrice: price,
                materials: currentRecipe,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if(!id) {
                // New
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                db.collection('print_models').add(data).then(() => closeModal());
            } else {
                // Update
                db.collection('print_models').doc(id).update(data).then(() => closeModal());
            }
        }

        function filterModels() {
            const filter = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('modelsList'); list.innerHTML = "";
            const filtered = allModels.filter(m => m.name.toLowerCase().includes(filter));
            filtered.forEach(m => renderCard(m, list));
        }
    </script>
</body>
</html>