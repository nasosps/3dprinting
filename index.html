<!DOCTYPE html>
<html lang="el">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - P3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#18181b">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>
</head>

<body class="bg-[#18181b] text-white min-h-screen p-6 font-sans">
    <div class="max-w-6xl mx-auto pt-4 lg:pt-0">
        <!-- Header removed, using Sidebar -->

        <div
            class="bg-[#27272a] p-6 rounded-2xl border border-gray-800 shadow-2xl mb-8 grid grid-cols-3 gap-4 text-center mt-6">
            <div class="border-r border-gray-700">
                <div class="text-3xl font-bold text-green-500" id="dashActiveCount">-</div>
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mt-1">Ενεργες Παραγγελιες
                </div>
            </div>
            <div class="border-r border-gray-700">
                <div class="text-3xl font-bold text-teal-400" id="dashQuotesCount">-</div>
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mt-1">Προσφορες</div>
            </div>
            <div>
                <div class="text-3xl font-bold text-orange-500" id="dashLowStock">-</div>
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mt-1">Low Stock</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <a href="quotes.html"
                class="bg-gray-800 p-8 rounded-2xl border border-gray-700 hover:border-teal-500 transition group relative overflow-hidden">
                <i
                    class="fas fa-file-invoice-dollar text-4xl text-teal-500 mb-4 group-hover:scale-110 transition block"></i>
                <h2 class="text-2xl font-bold mb-2">Προσφορές</h2>
                <div class="mt-6 flex items-center text-teal-400 text-xs font-bold uppercase tracking-wider">Μεταβαση <i
                        class="fas fa-arrow-right ml-2"></i></div>
            </a>
            <a href="orders.html"
                class="bg-gray-800 p-8 rounded-2xl border border-gray-700 hover:border-green-500 transition group relative overflow-hidden">
                <i
                    class="fas fa-truck-ramp-box text-4xl text-green-500 mb-4 group-hover:scale-110 transition block"></i>
                <h2 class="text-2xl font-bold mb-2">Παραγγελίες</h2>
                <div class="mt-6 flex items-center text-green-500 text-xs font-bold uppercase tracking-wider">Μεταβαση
                    <i class="fas fa-arrow-right ml-2"></i>
                </div>
            </a>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a href="materials.html"
                class="bg-[#27272a] p-4 rounded-xl border border-gray-700 hover:border-yellow-500 transition text-center group"><i
                    class="fas fa-boxes text-yellow-500 mb-2 block group-hover:scale-110 transition"></i><span
                    class="text-xs font-bold uppercase text-gray-300">Υλικά</span></a>
            <a href="clients.html"
                class="bg-[#27272a] p-4 rounded-xl border border-gray-700 hover:border-blue-500 transition text-center group"><i
                    class="fas fa-users text-blue-500 mb-2 block group-hover:scale-110 transition"></i><span
                    class="text-xs font-bold uppercase text-gray-300">Πελάτες</span></a>
            <a href="models.html"
                class="bg-[#27272a] p-4 rounded-xl border border-gray-700 hover:border-purple-500 transition text-center group"><i
                    class="fas fa-cube text-purple-500 mb-2 block group-hover:scale-110 transition"></i><span
                    class="text-xs font-bold uppercase text-gray-300">Μοντέλα</span></a>
            <a href="accessories.html"
                class="bg-[#27272a] p-4 rounded-xl border border-gray-700 hover:border-indigo-500 transition text-center group"><i
                    class="fas fa-microchip text-indigo-500 mb-2 block group-hover:scale-110 transition"></i><span
                    class="text-xs font-bold uppercase text-gray-300">Extras</span></a>
        </div>
    </div>

    <div class="fixed bottom-8 right-6 flex flex-col gap-4 z-30">
        <button onclick="openQuickModal()"
            class="w-16 h-16 bg-purple-600 rounded-full flex justify-center items-center shadow-[0_0_25px_rgba(147,51,234,0.6)] hover:scale-110 transition text-white text-2xl"
            title="Γρήγορη Καταγραφή">
            <i class="fas fa-bolt"></i>
        </button>
    </div>

    <!-- Quick Log Modal -->
    <div id="quickModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-center justify-center">
        <div class="bg-[#18181b] p-6 rounded-2xl border border-gray-700 w-full max-w-sm shadow-2xl relative">
            <h3 class="text-xl font-bold text-purple-400 mb-4 text-center">Γρήγορη Καταγραφή</h3>

            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase block mb-2">Υλικό</label>
                    <select id="quickMatSel"
                        class="w-full p-3 rounded-xl bg-[#27272a] border border-gray-600 text-white outline-none focus:border-purple-500"></select>
                </div>
                <div>
                    <label class="text-xs text-gray-500 font-bold uppercase block mb-2">Βάρος (gr)</label>
                    <input type="number" id="quickGrams"
                        class="w-full p-3 rounded-xl bg-[#27272a] border border-gray-600 text-white text-center text-xl font-bold focus:border-purple-500 outline-none"
                        placeholder="0">
                </div>
                <button onclick="saveQuickPrint()"
                    class="w-full bg-purple-600 py-3 rounded-xl font-bold text-white hover:bg-purple-500 transition shadow-lg mt-2">
                    <i class="fas fa-check mr-2"></i> Αφαίρεση
                </button>
            </div>

            <button onclick="document.getElementById('quickModal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-500 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        renderSidebar('dashboard');

        async function loadStats() {
            const { count: activeCount } = await sb.from('orders').select('*', { count: 'exact', head: true }).neq('status', 'archived');
            document.getElementById('dashActiveCount').innerText = activeCount || 0;

            const { count: quoteCount } = await sb.from('quotes').select('*', { count: 'exact', head: true });
            document.getElementById('dashQuotesCount').innerText = quoteCount || 0;

            const { data: mats } = await sb.from('materials').select('id, brand, type, color, current_weight');
            let low = 0;
            const matSel = document.getElementById('quickMatSel');
            matSel.innerHTML = '<option value="">-- Επίλεξε --</option>';

            if (mats) mats.forEach(m => {
                if (m.current_weight < 200) low++;
                matSel.innerHTML += `<option value="${m.id}">${m.color} (${m.brand} ${m.type}) - ${Math.round(m.current_weight)}g</option>`;
            });
            document.getElementById('dashLowStock').innerText = low;
        }
        setTimeout(loadStats, 500);

        function openQuickModal() {
            document.getElementById('quickGrams').value = "";
            document.getElementById('quickModal').classList.remove('hidden');
        }

        async function saveQuickPrint() {
            const mId = document.getElementById('quickMatSel').value;
            const g = parseFloat(document.getElementById('quickGrams').value);

            if (!mId || !g) return showToast("Λείπουν στοιχεία", 'error');

            try {
                // Fetch current first to allow simple subtraction
                const { data: mat, error: fError } = await sb.from('materials').select('current_weight').eq('id', mId).single();
                if (fError) throw fError;

                const newWeight = mat.current_weight - g;
                const { error: uError } = await sb.from('materials').update({ current_weight: newWeight }).eq('id', mId);
                if (uError) throw uError;

                showToast(`Αφαιρέθηκαν ${g}g!`, 'success');
                document.getElementById('quickModal').classList.add('hidden');
                loadStats(); // Update low stock counter and dropdown list
            } catch (e) {
                console.error(e);
                showToast("Σφάλμα: " + e.message, 'error');
            }
        }
    </script>
</body>

</html>