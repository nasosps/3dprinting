<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <title>Παραγγελίες & Παραγωγή</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:#18181b}::-webkit-scrollbar-thumb{background:#3f3f46;border-radius:4px}</style>
</head>
<body class="bg-[#18181b] text-white min-h-screen relative font-sans selection:bg-green-500 selection:text-white">

    <div class="max-w-3xl mx-auto p-4 pb-24">
        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4 sticky top-0 bg-[#18181b] z-10 pt-2">
            <div class="flex items-center gap-4">
                <a href="index.html" class="bg-gray-800 w-10 h-10 rounded-full flex justify-center items-center hover:bg-gray-700 transition"><i class="fas fa-arrow-left"></i></a>
                <h1 class="text-2xl font-bold text-green-500">Παραγωγή</h1>
            </div>
            <div id="orderCount" class="text-xs text-gray-500 font-mono"></div>
        </div>
        <div id="ordersList" class="space-y-4"></div>
    </div>

    <button onclick="openNewOrderModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-green-600 rounded-full flex justify-center items-center shadow-lg hover:scale-110 transition z-20 text-white text-2xl"><i class="fas fa-plus"></i></button>

    <div id="orderModal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-2 backdrop-blur-sm">
        <div class="bg-[#27272a] p-5 rounded-2xl w-full max-w-lg border border-gray-700 max-h-[95vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-green-400" id="modalTitle">Διαχείριση Παραγγελίας</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="space-y-3">
                <input type="hidden" id="editOrderId">
                <div><label class="text-[10px] text-gray-400 uppercase font-bold ml-1">Πελατης</label><select id="selClient" class="w-full p-3 rounded-lg bg-[#202022] border border-gray-600 text-white outline-none focus:border-green-500"></select></div>
                <div><label class="text-[10px] text-gray-400 uppercase font-bold ml-1">Preset</label><select id="selModel" class="w-full p-2 rounded bg-[#202022] border border-gray-600 text-sm outline-none focus:border-green-500" onchange="applyPreset()"><option value="">-- Preset --</option></select></div>
                <input type="text" id="inpTitle" class="w-full p-2 rounded bg-[#202022] border border-gray-600 outline-none focus:border-green-500" placeholder="Τίτλος Έργου">

                <div class="bg-gray-800 p-2 rounded-xl border border-green-900/30">
                    <div class="grid grid-cols-3 gap-1 mb-1">
                        <select id="filterBrand" class="w-full p-1 rounded bg-gray-900 text-xs border border-gray-600 text-gray-300 outline-none" onchange="updateMatFilters('brand')"><option value="">Μάρκα</option></select>
                        <select id="filterType" class="w-full p-1 rounded bg-gray-900 text-xs border border-gray-600 text-gray-300 outline-none" onchange="updateMatFilters('type')"><option value="">Είδος</option></select>
                        <select id="filterColor" class="w-full p-1 rounded bg-gray-900 text-xs border border-gray-600 text-gray-300 outline-none" onchange="updateMatFilters('color')"><option value="">Χρώμα</option></select>
                    </div>
                    <div id="usedMatsList" class="mt-2 space-y-1"></div>
                </div>

                <div class="bg-gray-800 p-2 rounded-xl border border-gray-600 shadow-inner">
                    <div class="grid grid-cols-3 gap-2">
                        <div><label class="text-[9px] text-gray-500 block text-center uppercase">Batch Pcs</label><input type="number" id="batchPcs" value="1" class="w-full p-1 bg-gray-900 border border-gray-600 text-center text-sm rounded outline-none font-bold" oninput="calcUnit()"></div>
                        <div><label class="text-[9px] text-gray-500 block text-center uppercase">Batch Gr</label><input type="number" id="bGrams" readonly class="w-full p-1 bg-gray-700 border border-gray-600 text-center text-sm rounded text-gray-400 cursor-not-allowed"></div>
                        <div><label class="text-[9px] text-gray-500 block text-center uppercase">Batch Min</label><input type="number" id="bMins" class="w-full p-1 bg-gray-900 border border-gray-600 text-center text-sm rounded outline-none" oninput="calcUnit()"></div>
                    </div>
                    <div class="text-center text-[10px] text-gray-500 mt-1 italic">
                        Ανά τεμ: <span id="resGrams">0</span>g | <span id="resMins">0</span>min
                    </div>
                </div>

                <div id="usedExtList" class="space-y-1"></div>

                <div class="bg-[#202022] p-4 rounded-xl border border-gray-600">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] text-gray-400 uppercase font-bold block mb-1">Τεμ. Παραγγελιας</label><input type="number" id="inpQty" value="1" class="w-full p-2 bg-gray-900 border border-gray-600 text-center text-white font-bold rounded text-lg outline-none" oninput="recalc()"></div>
                        <div><label class="text-[10px] text-green-400 font-bold uppercase block mb-1">Τιμη Μοναδας (€)</label><input type="number" id="inpUnitPrice" class="w-full p-2 bg-gray-900 border border-green-600 text-center text-white font-bold rounded text-lg outline-none" placeholder="0.00" oninput="recalc()"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-center mt-3 text-[10px]">
                        <div class="bg-gray-900/50 p-1 rounded border border-gray-800 uppercase font-bold text-gray-500 tracking-tighter">ΚΟΣΤΟΣ: <span id="resTotalCost" class="text-red-400 font-bold text-xs ml-1">0.00</span>€</div>
                        <div class="bg-gray-900/50 p-1 rounded border border-gray-800 uppercase font-bold text-gray-500 tracking-tighter">ΚΕΡΔΟΣ: <span id="resNetProfit" class="text-green-400 font-bold text-xs ml-1">0.00</span>€</div>
                    </div>
                    <div class="text-center text-3xl font-extrabold text-white mt-3"><span id="resTotalPrice">0.00</span>€</div>
                </div>

                <button onclick="saveOrder()" class="w-full bg-green-600 p-3 rounded-xl font-bold hover:bg-green-500 transition shadow-lg text-lg text-white uppercase">ΑΠΟΘΗΚΕΥΣΗ ΠΑΡΑΓΓΕΛΙΑΣ</button>
            </div>
        </div>
    </div>

    <div id="logModal" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
        <div class="bg-[#27272a] p-6 rounded-2xl w-full max-w-xs border border-gray-700 shadow-2xl">
            <h3 class="text-white font-bold mb-2 text-center">Καταγραφή Εκτύπωσης</h3>
            <p id="logInfo" class="text-[10px] text-gray-400 text-center mb-4 italic"></p>
            <input type="number" id="logPcs" placeholder="Τεμάχια;" class="w-full p-3 bg-gray-900 border border-green-500 text-center text-white font-bold rounded-xl text-2xl outline-none mb-4">
            <div class="flex gap-2">
                <button onclick="document.getElementById('logModal').classList.add('hidden')" class="flex-1 bg-gray-700 py-2 rounded font-bold text-sm">Ακυρο</button>
                <button onclick="submitProductionLog()" class="flex-1 bg-green-600 py-2 rounded font-bold hover:bg-green-500 text-sm">Ενημερωση</button>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let mats=[], extras=[], currentMats=[], currentExtras=[], loadedPresets={}, activeOrderId=null;

        setTimeout(() => {
            db.collection('customers').orderBy('name').onSnapshot(s => { const el=document.getElementById('selClient'); el.innerHTML=""; s.forEach(d=>el.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`); });
            db.collection('materials').onSnapshot(s => { mats=[]; s.forEach(d=>mats.push({...d.data(), id:d.id})); populateFilters(); });
            db.collection('accessories').onSnapshot(s => { extras=[]; s.forEach(d=>extras.push({...d.data(), id:d.id})); });
            db.collection('print_models').onSnapshot(s => { loadedPresets={}; const el=document.getElementById('selModel'); el.innerHTML='<option value="">-- Preset --</option>'; s.forEach(d=>{ loadedPresets[d.id]=d.data(); el.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`; }); });
            loadOrders();
        }, 1000);

        function loadOrders() {
            db.collection('orders').orderBy('date', 'desc').onSnapshot(snap => {
                const list = document.getElementById('ordersList'); list.innerHTML = "";
                document.getElementById('orderCount').innerText = snap.size + " παραγγελίες";
                db.collection('customers').get().then(csnap => {
                    const cMap = {}; csnap.forEach(c => cMap[c.id] = c.data().name);
                    snap.forEach(doc => {
                        const o = doc.data(); const progress = Math.min(100, Math.round((o.completedPieces / o.totalPieces) * 100)) || 0;
                        list.innerHTML += `
                        <div class=\"bg-[#27272a] p-4 rounded-xl border border-gray-700 relative group overflow-hidden\">
                            <div class=\"flex justify-between items-start mb-3\">
                                <div><div class=\"text-[10px] text-gray-500 mb-1\">${o.date ? new Date(o.date.seconds*1000).toLocaleDateString() : ''} • ${cMap[o.clientId]||'Πελάτης'}</div><div class=\"font-bold text-white\">${o.description}</div><div class=\"text-xs text-gray-400 mt-1\">${o.completedPieces} / ${o.totalPieces} τεμ.</div></div>
                                <div class=\"text-right\"><div class=\"text-xl font-bold text-green-400\">${(o.salePrice||0).toFixed(2)}€</div><button onclick=\"openLogModal('${doc.id}', ${o.totalPieces}, ${o.completedPieces})\" class=\"mt-2 bg-green-600/20 text-green-400 px-3 py-1 rounded-full text-[10px] font-bold border border-green-500/30 hover:bg-green-600 hover:text-white transition\">LOG PRINT</button></div>
                            </div>
                            <div class=\"w-full bg-gray-800 rounded-full h-1.5 overflow-hidden\"><div class=\"bg-green-500 h-full transition-all duration-500\" style=\"width: ${progress}%\"></div></div>
                            <div class=\"flex justify-between mt-3 opacity-0 group-hover:opacity-100 transition\"><button onclick=\"editOrder('${doc.id}')\" class=\"text-blue-400 text-xs p-1 hover:text-white transition shadow-sm\"><i class=\"fas fa-pen\"></i></button><button onclick=\"deleteOrderWithRefund('${doc.id}')\" class=\"text-red-500 text-[10px]\"><i class=\"fas fa-trash\"></i></button></div>
                        </div>`;
                    });
                });
            });
        }

        function populateFilters() {
            const brands = [...new Set(mats.map(m => m.brand))].sort();
            const el = document.getElementById('filterBrand'); el.innerHTML = '<option value="">Μάρκα</option>';
            brands.forEach(b => el.innerHTML += `<option value="${b}">${b}</option>`);
        }
        function updateMatFilters(changed) {
            const b = document.getElementById('filterBrand').value; const t = document.getElementById('filterType').value;
            if(changed==='brand'){
                const types = [...new Set(mats.filter(m=>!b || m.brand==b).map(m=>m.type))].sort();
                document.getElementById('filterType').innerHTML = '<option value="">Είδος</option>' + types.map(x=>`<option value="${x}">${x}</option>`).join('');
            }
            if(changed==='brand'||changed==='type'){
                const colors = mats.filter(m=>(!b||m.brand==b)&&(!t||m.type==t));
                document.getElementById('filterColor').innerHTML = '<option value="">Χρώμα</option>' + colors.map(m=>`<option value="${m.color}" data-id="${m.id}">${m.color}</option>`).join('');
            }
        }
        function toggleBatch() { calcUnit(); }
        
        function applyPreset() { 
            const id = document.getElementById('selModel').value; if(!id || !loadedPresets[id]) return; 
            const m = loadedPresets[id]; document.getElementById('inpTitle').value = m.name; 
            document.getElementById('batchPcs').value = m.batchPcs || 1; document.getElementById('bMins').value = m.batchMins || 0; 
            document.getElementById('inpUnitPrice').value = m.unitPrice || "";
            currentMats = m.materials ? JSON.parse(JSON.stringify(m.materials)) : []; renderRows(); 
        }

        function renderRows() {
            document.getElementById('usedMatsList').innerHTML = currentMats.map((m,i)=>`<div class=\"flex justify-between text-[10px] bg-gray-900 p-1 rounded border border-gray-700 mb-1\"><span>${m.name} (${m.grams}g)</span><button onclick=\"currentMats.splice(${i},1);renderRows()\" class=\"text-red-400\">x</button></div>`).join('');
            let sumG=0; currentMats.forEach(m=>sumG+=m.grams); document.getElementById('bGrams').value=sumG; calcUnit();
        }
        function calcUnit() {
            const p = parseFloat(document.getElementById('batchPcs').value) || 1;
            const g = parseFloat(document.getElementById('bGrams').value) || 0;
            const m = parseFloat(document.getElementById('bMins').value) || 0;
            document.getElementById('resGrams').innerText = (g/p).toFixed(2);
            document.getElementById('resMins').innerText = (m/p).toFixed(2);
            recalc();
        }
        function recalc() {
            const qty=parseFloat(document.getElementById('inpQty').value)||1; const uprice=parseFloat(document.getElementById('inpUnitPrice').value)||0;
            const bPcs=parseFloat(document.getElementById('batchPcs').value)||1;
            
            let mCostBatch=0; currentMats.forEach(m=>mCostBatch+=(m.grams*(m.price/1000)));
            let eCostUnit=0; currentExtras.forEach(e=>eCostUnit+=e.cost);
            const unitMins = parseFloat(document.getElementById('resMins').innerText) || 0;
            const powerCostUnit = (unitMins / 60) * 0.75;

            const totalCostOrder = (((mCostBatch/bPcs) + eCostUnit + powerCostUnit) * qty);
            const totalPriceOrder = uprice * qty;
            
            document.getElementById('resTotalCost').innerText = totalCostOrder.toFixed(2);
            document.getElementById('resTotalPrice').innerText = totalPriceOrder.toFixed(2);
            document.getElementById('resNetProfit').innerText = (totalPriceOrder - totalCostOrder).toFixed(2);
            return { totalCost: totalCostOrder, totalPrice: totalPriceOrder };
        }

        function openNewOrderModal() { currentMats=[]; currentExtras=[]; document.getElementById('editOrderId').value=""; document.getElementById('inpTitle').value=""; document.getElementById('inpQty').value="1"; document.getElementById('inpUnitPrice').value=""; renderRows(); document.getElementById('orderModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('orderModal').classList.add('hidden'); }
        function saveOrder() {
            const id=document.getElementById('editOrderId').value; const cData = recalc();
            const oData = {
                clientId: document.getElementById('selClient').value, description: document.getElementById('inpTitle').value,
                totalPieces: parseFloat(document.getElementById('inpQty').value), completedPieces: 0,
                unitPrice: parseFloat(document.getElementById('inpUnitPrice').value),
                salePrice: cData.totalPrice, totalCost: cData.totalCost,
                batchPcs: parseFloat(document.getElementById('batchPcs').value), 
                batchGrams: parseFloat(document.getElementById('bGrams').value),
                batchMins: parseFloat(document.getElementById('bMins').value),
                materials: currentMats, extras: currentExtras, status: 'pending', date: firebase.firestore.FieldValue.serverTimestamp()
            };
            const action = id ? db.collection('orders').doc(id).update(oData) : db.collection('orders').add(oData);
            action.then(() => closeModal());
        }
        function editOrder(id) {
            db.collection('orders').doc(id).get().then(doc => {
                const o = doc.data(); document.getElementById('editOrderId').value = id; document.getElementById('selClient').value = o.clientId;
                document.getElementById('inpTitle').value = o.description; document.getElementById('inpQty').value = o.totalPieces;
                document.getElementById('inpUnitPrice').value = o.unitPrice; 
                document.getElementById('batchPcs').value = o.batchPcs || 1;
                document.getElementById('bMins').value = o.batchMins || 0;
                currentMats = o.materials || []; currentExtras = o.extras || [];
                renderRows(); document.getElementById('orderModal').classList.remove('hidden');
            });
        }
        function openLogModal(id, total, completed) { activeOrderId = id; document.getElementById('logInfo').innerText = `Υπόλοιπο: ${total - completed} τεμ.`; document.getElementById('logPcs').value = ""; document.getElementById('logModal').classList.remove('hidden'); }
        function submitProductionLog() {
            const pcs = parseFloat(document.getElementById('logPcs').value); if(!pcs || pcs <= 0) return alert("Βάλε αριθμό!");
            db.collection('orders').doc(activeOrderId).get().then(doc => {
                const o = doc.data(); const newCompleted = (o.completedPieces || 0) + pcs; const batch = db.batch();
                batch.update(db.collection('orders').doc(activeOrderId), { completedPieces: newCompleted, status: newCompleted >= o.totalPieces ? 'completed' : 'in_progress' });
                if(o.materials) o.materials.forEach(m => { const deduct = (m.grams / (o.batchPcs || 1)) * pcs; batch.update(db.collection('materials').doc(m.id), { currentWeight: firebase.firestore.FieldValue.increment(-deduct) }); });
                if(o.extras) o.extras.forEach(e => { batch.update(db.collection('accessories').doc(e.id), { stock: firebase.firestore.FieldValue.increment(-pcs) }); });
                batch.commit().then(() => document.getElementById('logModal').classList.add('hidden'));
            });
        }
        function deleteOrderWithRefund(id) {
            if(!confirm("Διαγραφή; Η αποθήκη θα ενημερωθεί.")) return;
            db.collection('orders').doc(id).get().then(doc => {
                const o = doc.data(); const refundPcs = o.completedPieces || 0; const batch = db.batch();
                if(refundPcs > 0) {
                    if(o.materials) o.materials.forEach(m => { const refundGrams = (m.grams / (o.batchPcs || 1)) * refundPcs; batch.update(db.collection('materials').doc(m.id), { currentWeight: firebase.firestore.FieldValue.increment(refundGrams) }); });
                    if(o.extras) o.extras.forEach(e => { batch.update(db.collection('accessories').doc(e.id), { stock: firebase.firestore.FieldValue.increment(refundPcs) }); });
                }
                batch.delete(db.collection('orders').doc(id)); batch.commit();
            });
        }
    </script>
</body>
</html>