<!DOCTYPE html>
<html lang="el">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎÎ­Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± - 3D Printing Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#09090b">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
    </style>
</head>

<body class="bg-[#09090b] text-white font-sans antialiased pb-20">

    <!-- Back Button -->
    <a href="index.html"
        class="fixed top-4 left-4 z-50 bg-gray-800/80 p-3 rounded-full text-white hover:bg-gray-700 transition shadow-lg backdrop-blur-md">
        <i class="fas fa-arrow-left"></i>
    </a>

    <header
        class="fixed top-0 left-0 right-0 bg-black/95 backdrop-blur-md z-40 px-4 py-3 border-b border-gray-800 flex justify-between items-center transition-all duration-300">
        <div class="pl-12 md:pl-20 flex items-center gap-4 flex-1"> <!-- Space for Back Button -->
            <h1
                class="hidden md:block text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">
                Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯ÎµÏ‚</h1>

            <!-- Global Search Bar -->
            <div class="relative w-full max-w-md">
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                <input type="text" id="orderSearch" onkeyup="filterOrders()"
                    class="w-full bg-gray-900/50 border border-gray-700 rounded-full py-2.5 pl-10 pr-4 text-white focus:border-blue-500 outline-none transition"
                    placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·...">
            </div>
        </div>
        <div class="flex gap-2 ml-2">
            <button onclick="openNewModal()"
                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg shadow-blue-900/20 transition flex items-center gap-2 whitespace-nowrap">
                <i class="fas fa-plus"></i> <span class="hidden sm:inline">ÎÎ­Î±</span></button>
            <button onclick="toggleView()" id="viewToggleBtn"
                class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-4 py-2 rounded-full text-sm font-bold transition flex items-center gap-2 whitespace-nowrap">
                <i class="fas fa-archive"></i> <span class="hidden sm:inline">Î‘ÏÏ‡ÎµÎ¯Î¿</span></button>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 pt-24">

        <!-- Active Orders Grid -->
        <div id="activeOrdersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
            <!-- Cards injected here -->
        </div>

        <!-- Archived Orders List -->
        <div id="archivedOrdersList" class="hidden space-y-4 pb-20">
            <!-- List items injected here -->
        </div>

    </div>

    <!-- ADVANCED ORDER MODAL -->
    <div id="orderModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-start justify-center overflow-y-auto">
        <div
            class="w-full min-h-screen sm:min-h-0 sm:max-w-xl sm:my-10 bg-[#18181b] sm:rounded-2xl sm:border border-gray-700 shadow-2xl flex flex-col relative">

            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-[#202022] sm:rounded-t-2xl">
                <h3 class="text-xl font-bold text-blue-400" id="modalTitle">ÎÎ­Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±</h3>
                <button onclick="closeModal()"
                    class="bg-gray-800 w-10 h-10 rounded-full text-gray-400 hover:text-white flex items-center justify-center border border-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 space-y-6 pb-24">
                <input type="hidden" id="editOrderId">

                <div class="space-y-4">
                    <div>
                        <label
                            class="text-xs text-gray-500 uppercase font-bold ml-1 mb-1 block tracking-wider">Î ÎµÎ»Î¬Ï„Î·Ï‚</label>
                        <div class="flex gap-2">
                            <input type="text" id="client" list="clientList"
                                class="w-full p-3 rounded-xl bg-[#27272a] border border-gray-600 text-white outline-none focus:border-blue-500 shadow-sm"
                                placeholder="ÎŒÎ½Î¿Î¼Î± Ï€ÎµÎ»Î¬Ï„Î·...">
                            <datalist id="clientList"></datalist>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-500 font-bold uppercase ml-1 mb-1 block tracking-wider">Î¤Î¯Ï„Î»Î¿Ï‚
                            ÎˆÏÎ³Î¿Ï… / Preset</label>
                        <div class="flex gap-2">
                            <input type="text" id="inpTitle"
                                class="w-full p-3 rounded-xl bg-[#27272a] border border-gray-600 outline-none focus:border-blue-500 font-bold placeholder-gray-500 shadow-sm"
                                placeholder="Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®...">
                            <select id="selModel"
                                class="w-1/3 p-3 rounded-xl bg-[#202022] border border-gray-600 text-xs outline-none focus:border-blue-500"
                                onchange="applyPreset()">
                                <option value="">-- Preset --</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- MATERIALS SECTION -->
                <div class="bg-gray-800/30 p-4 rounded-2xl border border-blue-900/30">
                    <div class="text-xs text-blue-400 font-bold mb-3 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-fill-drip"></i> Î¥Î»Î¹ÎºÎ± & Î§ÏÏ‰Î¼Î±Ï„Î±
                    </div>

                    <div class="grid grid-cols-1 gap-3 mb-3 relative">
                        <div class="relative">
                            <input type="text" id="materialSearch"
                                class="w-full p-3 rounded-xl bg-[#27272a] border border-gray-600 text-white text-sm focus:border-blue-500 outline-none shadow-inner"
                                placeholder="ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..." onkeyup="filterMaterialList()"
                                onfocus="filterMaterialList()">
                            <div id="materialDropdown"
                                class="hidden absolute z-50 w-full bg-[#27272a] border border-gray-600 rounded-lg max-h-48 overflow-y-auto shadow-xl mt-1">
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 items-center bg-[#27272a] p-3 rounded-xl border border-gray-600 shadow-lg">
                        <div id="selectedMatInfo"
                            class="flex-grow text-sm text-gray-300 italic px-2 font-medium truncate">--</div>
                        <input type="number" id="addMatGrams" placeholder="Gr"
                            class="w-20 p-2 rounded-lg bg-gray-900 text-lg text-center border border-gray-500 text-white font-bold outline-none focus:border-blue-500">
                        <button onclick="addMaterialRow()"
                            class="bg-blue-600 w-10 h-10 rounded-lg text-white hover:bg-blue-500 shadow-lg flex items-center justify-center"><i
                                class="fas fa-plus"></i></button>
                    </div>

                    <div id="usedMatsList" class="mt-3 space-y-2"></div>
                </div>

                <!-- BATCH & EXTRAS -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-800/30 p-4 rounded-2xl border border-gray-600/30">
                        <label class="text-xs text-gray-400 block mb-2 font-bold uppercase">Extras (â‚¬)</label>
                        <div class="flex gap-2">
                            <select id="addExtSel"
                                class="w-full p-2 rounded-lg bg-[#27272a] border border-gray-600 text-xs"></select>
                            <button onclick="addExtraRow()" class="bg-indigo-600 px-3 rounded-lg"><i
                                    class="fas fa-plus"></i></button>
                        </div>
                        <div id="usedExtList" class="mt-2 space-y-1"></div>
                    </div>

                    <div class="bg-gray-800/30 p-4 rounded-2xl border border-gray-600/30">
                        <label class="text-xs text-gray-400 block mb-2 font-bold uppercase">Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ· (Batch)</label>
                        <div class="grid grid-cols-2 gap-2 text-center">
                            <div>
                                <div class="text-[10px] text-gray-500">TEM/BATCH</div><input type="number" id="batchPcs"
                                    value="1" class="w-full bg-[#27272a] border border-gray-600 text-center rounded p-1"
                                    oninput="recalc()">
                            </div>
                            <div>
                                <div class="text-[10px] text-gray-500">MINS</div><input type="number" id="bMins"
                                    value="0" class="w-full bg-[#27272a] border border-gray-600 text-center rounded p-1"
                                    oninput="recalc()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PROGRESS & FINANCIALS -->
                <div class="bg-[#202022] p-5 rounded-3xl border border-gray-600 shadow-2xl space-y-4">

                    <!-- Progress Slider -->
                    <div>
                        <div class="flex justify-between text-xs font-bold uppercase text-gray-400 mb-1">
                            <span>Î ÏÎ¿Î¿Î´Î¿Ï‚</span>
                            <span class="text-white"><span id="progText">0</span> / <span id="totalText">1</span></span>
                        </div>
                        <input type="range" id="progressSlider" min="0" max="1" value="0" step="1"
                            class="w-full accent-green-500 h-4 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                            oninput="updateProgressUI()">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs text-gray-400 font-bold uppercase block mb-1">Î Î¿ÏƒÎ¿Ï„Î·Ï„Î±</label><input
                                type="number" id="inpQty" value="1"
                                class="w-full p-3 bg-[#18181b] border border-gray-600 text-center text-white font-bold rounded-xl text-2xl"
                                oninput="recalc()"></div>
                        <div><label class="text-xs text-blue-400 font-bold uppercase block mb-1">Î¤Î¹Î¼Î· (â‚¬)</label><input
                                type="number" id="inpUnitPrice"
                                class="w-full p-3 bg-[#18181b] border border-blue-500 text-center text-white font-bold rounded-xl text-2xl"
                                oninput="recalc()"></div>
                    </div>

                    <!-- Payments -->
                    <div class="bg-black/40 p-3 rounded-xl border border-gray-700 grid grid-cols-2 gap-4 items-center">
                        <div>
                            <label class="text-[10px] text-gray-500 font-bold uppercase block">Î ÏÎ¿ÎºÎ±Ï„Î±Î²Î¿Î»Î·</label>
                            <input type="number" id="inpDeposit" value="0"
                                class="w-full bg-transparent border-b border-gray-600 text-yellow-500 text-xl font-bold outline-none"
                                oninput="recalc()">
                        </div>
                        <div class="text-right">
                            <label class="text-[10px] text-gray-500 font-bold uppercase block">Î¥Ï€Î¿Î»Î¿Î¹Ï€Î¿</label>
                            <div class="text-xl font-bold text-red-400"><span id="resBalance">0.00</span>â‚¬</div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-2">
                        <label
                            class="flex items-center gap-2 cursor-pointer bg-gray-800 px-3 py-1 rounded-lg border border-gray-600">
                            <input type="checkbox" id="chkPaid" class="accent-green-500 w-4 h-4" onchange="recalc()">
                            <span class="text-xs font-bold uppercase text-gray-300">Î•Î¾Ï‰Ï†Î»Î·ÏƒÎ·</span>
                        </label>
                        <div class="text-right">
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Î£Î¥ÎÎŸÎ›ÎŸ</div>
                            <div class="text-3xl font-black text-white"><span id="resTotalPrice">0.00</span>â‚¬</div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="saveOrder()"
                        class="flex-1 bg-blue-600 py-4 rounded-xl font-bold hover:bg-blue-500 transition shadow-xl text-lg text-white uppercase tracking-wider">
                        <i class="fas fa-save mr-2"></i> Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…ÏƒÎ·
                    </button>
                    <button onclick="completeOrder()" id="btnComplete"
                        class="bg-green-600 py-4 px-6 rounded-xl font-bold hover:bg-green-500 transition shadow-xl text-white hidden">
                        <i class="fas fa-check"></i>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // --- DATA & STATE ---
        let orders = [], clients = [], mats = [], extras = [], loadedPresets = {}, currentMats = [], currentExtras = [], selectedSpool = null;
        let isArchivedView = false;

        // --- INIT ---
        renderSidebar('orders');
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            // Load Dependencies
            const [m, e, p, c] = await Promise.all([
                sb.from('materials').select('*'),
                sb.from('accessories').select('*'),
                sb.from('print_models').select('*'),
                sb.from('customers').select('*').order('name')
            ]);

            if (m.data) mats = m.data;
            if (e.data) extras = e.data;
            if (p.data) p.data.forEach(x => loadedPresets[x.id] = x);
            if (c.data) clients = c.data;

            // Populate Dropdowns
            const matSel = document.getElementById('addExtSel'); matSel.innerHTML = "";
            extras.forEach(x => matSel.innerHTML += `<option value="${x.id}">${x.name} (${x.cost}â‚¬)</option>`);

            const modSel = document.getElementById('selModel');
            Object.values(loadedPresets).forEach(x => modSel.innerHTML += `<option value="${x.id}">${x.name}</option>`);

            const cliList = document.getElementById('clientList'); cliList.innerHTML = "";
            clients.forEach(c => cliList.innerHTML += `<option value="${c.name}">`);

            loadData();
        }

        async function loadData() {
            const { data, error } = await sb.from('orders').select('*, customers(name)').order('created_at', { ascending: false });
            if (error) {
                console.error("LOAD ERROR:", error);
                // showToast("Error loading orders: " + error.message, 'error'); // Optional
            }
            if (data) {
                orders = data;
                renderOrders();
            }
        }

        function renderOrders() {
            const grid = document.getElementById('activeOrdersGrid');
            const list = document.getElementById('archivedOrdersList');
            grid.innerHTML = ""; list.innerHTML = "";

            const visibleOrders = orders.filter(o => isArchivedView ? o.status === 'Completed' : o.status !== 'Completed');

            if (visibleOrders.length === 0) {
                const msg = `<div class="col-span-full text-center text-gray-500 py-10 opacity-50 text-xl font-bold uppercase tracking-widest">ÎšÎµÎ½Î¿</div>`;
                if (isArchivedView) list.innerHTML = msg; else grid.innerHTML = msg;
                return;
            }

            visibleOrders.forEach(o => {
                const isPaid = o.is_paid;
                const progress = o.completed_pieces || 0;
                const total = o.total_pieces || 1;
                const percent = (progress / total) * 100;
                const balance = (o.sale_price || 0) - (o.deposit || 0);

                const html = `
                <div class="bg-[#18181b] p-6 md:p-5 rounded-[2rem] border border-gray-800 hover:border-blue-500/30 transition shadow-xl group relative overflow-hidden flex flex-col justify-between h-full min-h-[280px]">
                    <div>
                        <div class="flex justify-between items-start mb-4">
                             <div class="flex-1 pr-2">
                                 <div class="text-sm md:text-xs text-blue-400 font-extrabold uppercase tracking-widest mb-2">${o.customers?.name || 'Î‘Î³Î½Ï‰ÏƒÏ„Î¿Ï‚'}</div>
                                 <h3 class="font-bold text-white text-2xl md:text-xl leading-snug">${o.description}</h3>
                             </div>
                             <div class="text-right">
                                 <div class="text-3xl md:text-2xl font-black ${isPaid ? 'text-green-500' : (balance > 0 ? 'text-red-400' : 'text-gray-400')}">${Math.round(o.sale_price)}â‚¬</div>
                                 ${!isPaid && balance > 0 ? `<div class="text-xs text-red-500 font-bold uppercase mt-1">Î¥Ï€Î¿Î». ${balance}â‚¬</div>` : ''}
                             </div>
                        </div>

                        <!-- Progress Section with Quick Controls -->
                        <div class="mt-6 mb-4">
                            <div class="flex justify-between items-end mb-2">
                                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Î ÏÎ¿Î¿Î´Î¿Ï‚</span>
                                <div class="flex items-center gap-3">
                                    <button onclick="updateQuickProgress('${o.id}', -1, ${o.completed_pieces}, ${o.total_pieces})" class="w-10 h-10 rounded-full bg-gray-800 hover:bg-gray-700 text-white flex items-center justify-center border border-gray-700 active:scale-90 transition"><i class="fas fa-minus"></i></button>
                                    
                                    <div class="flex items-baseline gap-1">
                                        <input type="number" 
                                               value="${progress}" 
                                               onchange="manualProgressUpdate('${o.id}', this.value, ${progress}, ${o.total_pieces})"
                                               class="bg-transparent text-white font-black text-2xl w-16 text-center focus:outline-none focus:border-b-2 border-blue-500 appearance-none m-0 p-0" />
                                        <span class="text-base text-gray-500 font-normal">/ ${total}</span>
                                    </div>

                                    <button onclick="updateQuickProgress('${o.id}', 1, ${o.completed_pieces}, ${o.total_pieces})" class="w-10 h-10 rounded-full bg-blue-600 hover:bg-blue-500 text-white flex items-center justify-center shadow-lg active:scale-90 transition"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-3 overflow-hidden border border-gray-800/50">
                                <div class="bg-gradient-to-r from-blue-500 to-cyan-400 h-full transition-all duration-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-800 pt-4 mt-auto flex gap-3">
                        <button onclick="editOrder('${o.id}')" class="flex-1 bg-gray-800 hover:bg-gray-700 py-3 rounded-2xl text-gray-300 font-bold text-base transition flex items-center justify-center gap-2">
                            <i class="fas fa-pen"></i> <span class="uppercase text-xs tracking-wider">Edit</span>
                        </button>
                        ${o.status !== 'Completed' ?
                        `<button onclick="quickComplete('${o.id}')" class="w-16 bg-gray-800 hover:bg-green-900/40 hover:text-green-400 text-gray-500 rounded-2xl transition flex items-center justify-center">
                            <i class="fas fa-check text-xl"></i>
                        </button>`
                        : ''}
                    </div>
                </div>`;

                if (isArchivedView) list.innerHTML += html; else grid.innerHTML += html;
            });
        }

        // --- MODAL & LOGIC ---

        function openNewModal() {
            resetForm();
            document.getElementById('modalTitle').innerText = "ÎÎ­Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±";
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function editOrder(id) {
            const o = orders.find(x => x.id === id);
            if (!o) return;

            document.getElementById('editOrderId').value = o.id;
            document.getElementById('modalTitle').innerText = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±";

            document.getElementById('client').value = o.customers?.name || "";
            document.getElementById('inpTitle').value = o.description;
            document.getElementById('inpQty').value = o.total_pieces;
            document.getElementById('inpUnitPrice').value = o.unit_price;
            document.getElementById('inpDeposit').value = o.deposit || 0;
            document.getElementById('chkPaid').checked = o.is_paid;

            // Restore batch info
            document.getElementById('batchPcs').value = o.batch_pcs || 1;
            document.getElementById('bMins').value = o.batch_mins || 0;

            // Restore Progress
            document.getElementById('progressSlider').max = o.total_pieces;
            document.getElementById('progressSlider').value = o.completed_pieces;
            updateProgressUI();

            // Restore Materials
            currentMats = o.materials_used || [];
            currentExtras = o.extras_used || [];
            renderRows();

            if (o.status !== 'Completed') {
                document.getElementById('btnComplete').classList.remove('hidden');
            } else {
                document.getElementById('btnComplete').classList.add('hidden');
            }

            document.getElementById('orderModal').classList.remove('hidden');
            recalc();
        }

        function resetForm() {
            document.getElementById('editOrderId').value = "";
            document.getElementById('client').value = "";
            document.getElementById('inpTitle').value = "";
            document.getElementById('inpQty').value = "1";
            document.getElementById('inpUnitPrice').value = "";
            document.getElementById('inpDeposit').value = "0";
            document.getElementById('chkPaid').checked = false;
            document.getElementById('batchPcs').value = "1";
            document.getElementById('bMins').value = "0";
            document.getElementById('progressSlider').value = "0";
            document.getElementById('btnComplete').classList.add('hidden');
            currentMats = []; currentExtras = [];
            renderRows();
            recalc();
        }

        // ... Reuse Logic from Quotes (filterMaterial, addMaterial, etc.) ...
        // Simplified for brevity in this replace_file, focusing on core Logic

        function filterMaterialList() {
            const val = document.getElementById('materialSearch').value.toUpperCase();
            const dd = document.getElementById('materialDropdown');
            dd.innerHTML = ""; dd.classList.remove('hidden');
            const matches = mats.filter(m => (m.brand + m.type + m.color).toUpperCase().includes(val) || m.name?.toUpperCase().includes(val));
            // Dedupe similar to quotes...
            const unique = {};
            matches.forEach(m => {
                const k = `${m.brand} ${m.type} ${m.color}`;
                if (!unique[k] || unique[k].current_weight < m.current_weight) unique[k] = m;
            });
            Object.values(unique).forEach(m => {
                const d = document.createElement('div');
                d.className = "p-3 border-b border-gray-600 hover:bg-gray-700 cursor-pointer flex justify-between";
                d.innerHTML = `<span>${m.color} <span class="text-xs text-gray-400">${m.brand} ${m.type}</span></span> <span class="text-blue-400 font-bold">${Math.round(m.current_weight)}g</span>`;
                d.onclick = () => { selectMaterial(m); };
                dd.appendChild(d);
            });
            if (!matches.length) dd.innerHTML = '<div class="p-2 text-gray-500 text-center text-xs">??</div>';
        }
        function selectMaterial(m) {
            selectedSpool = m;
            document.getElementById('selectedMatInfo').innerText = `${m.brand} ${m.type} ${m.color}`;
            document.getElementById('materialDropdown').classList.add('hidden');
            document.getElementById('materialSearch').value = "";
        }
        function addMaterialRow() {
            if (!selectedSpool) return;
            const g = parseFloat(document.getElementById('addMatGrams').value); if (!g) return;
            currentMats.push({ id: selectedSpool.id, name: selectedSpool.name, price: selectedSpool.price, grams: g });
            document.getElementById('addMatGrams').value = ""; selectedSpool = null; document.getElementById('selectedMatInfo').innerText = "--";
            renderRows();
        }
        function addExtraRow() {
            const id = document.getElementById('addExtSel').value;
            const e = extras.find(x => x.id === id); if (e) currentExtras.push({ id: e.id, name: e.name, cost: e.cost });
            renderRows();
        }
        // Search Logic
        function filterOrders() {
            const val = document.getElementById('orderSearch').value.toLowerCase();
            const grid = document.getElementById('activeOrdersGrid');
            const list = document.getElementById('archivedOrdersList');
            const target = isArchivedView ? list : grid;

            const cards = target.children;
            for (let card of cards) {
                const text = card.innerText.toLowerCase();
                if (text.includes(val)) card.style.display = "flex";
                else card.style.display = "none";
            }
        }

        // Fix renderRows to show correct material name
        function renderRows() {
            const ml = document.getElementById('usedMatsList'); ml.innerHTML = "";
            currentMats.forEach((m, i) => {
                // 1. Try existing name
                let name = m.name;

                // 2. If no name (or generic), try to construct from item properties
                if (!name && m.brand) name = `${m.brand} ${m.type} ${m.color}`;

                // 3. Last Resort: Lookup in global 'mats' list using ID
                if (!name || name === "Material") {
                    const found = mats.find(x => x.id === m.id);
                    if (found) name = `${found.brand} ${found.type} ${found.color}`;
                }

                if (!name) name = "Unknown Material";

                ml.innerHTML += `
                <div class="flex justify-between items-center bg-[#18181b] p-4 rounded-xl border border-gray-700 text-base shadow-sm">
                    <span class="text-gray-300 font-medium">${name} <span class="text-blue-400 font-bold ml-2 text-lg">${m.grams}g</span></span>
                    <button onclick="currentMats.splice(${i},1);renderRows()" class="w-10 h-10 rounded-full bg-gray-800 text-red-400 hover:text-white hover:bg-red-500 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>`;
            });

            const el = document.getElementById('usedExtList'); el.innerHTML = "";
            currentExtras.forEach((e, i) => el.innerHTML += `<div class="flex justify-between items-center bg-[#18181b] p-4 rounded-xl border border-gray-700 text-base shadow-sm"><span class="text-gray-300">${e.name} (${e.cost}â‚¬)</span><button onclick="currentExtras.splice(${i},1);renderRows()" class="w-10 h-10 rounded-full bg-gray-800 text-red-400 hover:text-white hover:bg-red-500 transition flex items-center justify-center"><i class="fas fa-times"></i></button></div>`);
            recalc();
        }

        // Add proper names when adding material
        function addMaterialRow() {
            if (!selectedSpool) return;
            const g = parseFloat(document.getElementById('addMatGrams').value); if (!g) return;
            // Store full name logic
            const fullName = `${selectedSpool.brand} ${selectedSpool.type} ${selectedSpool.color}`;
            currentMats.push({ id: selectedSpool.id, name: fullName, price: selectedSpool.price, grams: g });
            document.getElementById('addMatGrams').value = ""; selectedSpool = null; document.getElementById('selectedMatInfo').innerText = "--";
            renderRows();
        }

        function recalc() {
            const qty = parseFloat(document.getElementById('inpQty').value) || 1;
            const uprice = parseFloat(document.getElementById('inpUnitPrice').value) || 0;
            const deposit = parseFloat(document.getElementById('inpDeposit').value) || 0;
            const isPaid = document.getElementById('chkPaid').checked;

            const total = uprice * qty;
            let balance = total - deposit;
            if (isPaid) balance = 0;

            document.getElementById('resTotalPrice').innerText = total.toFixed(2);
            document.getElementById('resBalance').innerText = balance.toFixed(2);

            // Update Slider Max
            const slider = document.getElementById('progressSlider');
            if (slider.max != qty) { slider.max = qty; updateProgressUI(); }
        }

        function updateProgressUI() {
            const val = document.getElementById('progressSlider').value;
            const max = document.getElementById('progressSlider').max;
            document.getElementById('progText').innerText = val;
            document.getElementById('totalText').innerText = max;
        }

        function applyPreset() {
            const id = document.getElementById('selModel').value; const p = loadedPresets[id];
            if (!p) return;
            document.getElementById('inpTitle').value = p.name;
            document.getElementById('inpUnitPrice').value = p.unit_price;
            document.getElementById('batchPcs').value = p.batch_pcs;
            document.getElementById('bMins').value = p.batch_mins;
            if (p.materials) currentMats = JSON.parse(JSON.stringify(p.materials));
            renderRows();
        }

        // --- SUBMIT --- 

        async function saveOrder() {
            const id = document.getElementById('editOrderId').value;
            const cName = document.getElementById('client').value;
            if (!cName) return showToast("Î’Î¬Î»Îµ Î ÎµÎ»Î¬Ï„Î·", 'error');

            try {
                // Find/Create Client
                let cId = clients.find(c => c.name.toLowerCase() === cName.toLowerCase())?.id;
                if (!cId) {
                    const { data: nc } = await sb.from('customers').insert({ name: cName }).select().single();
                    cId = nc.id;
                }

                const data = {
                    client_id: cId,
                    description: document.getElementById('inpTitle').value,
                    total_pieces: parseFloat(document.getElementById('inpQty').value),
                    completed_pieces: parseFloat(document.getElementById('progressSlider').value),
                    unit_price: parseFloat(document.getElementById('inpUnitPrice').value),
                    sale_price: parseFloat(document.getElementById('resTotalPrice').innerText),
                    deposit: parseFloat(document.getElementById('inpDeposit').value),
                    is_paid: document.getElementById('chkPaid').checked,
                    batch_pcs: parseFloat(document.getElementById('batchPcs').value),
                    batch_mins: parseFloat(document.getElementById('bMins').value),
                    materials_used: currentMats,
                    extras_used: currentExtras,
                    // Check completion logic
                    status: (parseFloat(document.getElementById('progressSlider').value) >= parseFloat(document.getElementById('inpQty').value)) ? 'Completed' : 'Active'
                };

                // Inventory Logic: If moving to Completed state (and wasn't before), deduct stock? 
                // Too complex for "Save". Let's rely on explicit "Complete" button for deduction, 
                // OR deduct incrementally based on progress? 
                // User asked for "Update warehouses".
                // Simplest robust way: 
                // If we save progress, we should ideally deduct ONLY the newly completed pieces. 
                // BUT tracking "what was deducted" is hard without extra tables.
                // DECISION: Deduct materials ONLY when clicking "Complete Order" (Finalize). 
                // "Save" just updates text/money/progress display.

                let updateError = null;
                if (id) {
                    const { error } = await sb.from('orders').update(data).eq('id', id);
                    updateError = error;
                } else {
                    const { error } = await sb.from('orders').insert(data);
                    updateError = error;
                }

                if (updateError) throw updateError;

                closeModal(); loadData(); showToast("Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ");

            } catch (e) {
                console.error("SAVE ERROR:", e);
                showToast(e.message || "Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚", 'error');
            }
        }

        async function completeOrder() {
            // Deduct Stock Logic
            if (!confirm("ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· & Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Î¥Î»Î¹ÎºÏÎ½ Î±Ï€ÏŒ Î‘Ï€Î¿Î¸Î®ÎºÎ·;")) return;

            // 1. Calculate Total Weight per Material ID
            // Total Weight = (MatGramsPerBatch / BatchPcs) * TotalQty
            const qty = parseFloat(document.getElementById('inpQty').value);
            const bPcs = parseFloat(document.getElementById('batchPcs').value) || 1;

            for (const m of currentMats) {
                const totalGramsNeeded = (m.grams / bPcs) * qty;
                // Fetch current weight
                const { data: spool } = await sb.from('materials').select('current_weight').eq('id', m.id).single();
                if (spool) {
                    const newW = spool.current_weight - totalGramsNeeded;
                    await sb.from('materials').update({ current_weight: newW }).eq('id', m.id);
                }
            }

            // Update Status
            document.getElementById('progressSlider').value = qty; // Max out progress
            document.getElementById('chkPaid').checked = true; // Assume paid on close? Or optional? Let's not force paid.

            await saveOrder(); // This will save as Completed
        }

        // Helpers
        function toggleView() {
            isArchivedView = !isArchivedView;

            // Toggle container visibility
            const activeGrid = document.getElementById('activeOrdersGrid');
            const archiveList = document.getElementById('archivedOrdersList');

            if (isArchivedView) {
                activeGrid.classList.add('hidden');
                archiveList.classList.remove('hidden');
                document.getElementById('viewToggleBtn').innerHTML = '<i class="fas fa-list mr-2"></i>Î•Î½ÎµÏÎ³Î­Ï‚';
            } else {
                activeGrid.classList.remove('hidden');
                archiveList.classList.add('hidden');
                document.getElementById('viewToggleBtn').innerHTML = '<i class="fas fa-archive mr-2"></i>Î‘ÏÏ‡ÎµÎ¯Î¿';
            }

            renderOrders();
        }
        function closeModal() { document.getElementById('orderModal').classList.add('hidden'); }

        // Hide Dropdown onClick outside
        document.addEventListener('click', (e) => {
            if (!document.getElementById('materialDropdown').contains(e.target) && e.target.id !== 'materialSearch')
                document.getElementById('materialDropdown').classList.add('hidden');
        });

        async function updateQuickProgress(id, change, current, total) {
            let newVal = (current || 0) + change;
            if (newVal < 0) newVal = 0;
            if (newVal > total) newVal = total;

            if (newVal === current) return; // No change

            try {
                // 1. Update Order Progress
                const { error } = await sb.from('orders').update({ completed_pieces: newVal }).eq('id', id);
                if (error) throw error;

                // 2. If INCREASING progress (printing), deduct materials
                if (change > 0) {
                    // Fetch order details to know what materials to deduct
                    const { data: ord } = await sb.from('orders').select('materials_used, batch_pcs').eq('id', id).single();

                    if (ord && ord.materials_used && ord.materials_used.length > 0) {
                        const batchPcs = ord.batch_pcs || 1;
                        const piecesAdded = newVal - current; // Should correspond to 'change' but safer to calc

                        for (const m of ord.materials_used) {
                            // Calc grams per piece = (TotalGramsInBatch / BatchPcs)
                            // So TotalDeduct = (GramsPerPiece) * piecesAdded
                            // m.grams is the grams for the BATCH (as saved in renderRows/addMaterialRow context? NO. 
                            // Wait, in quotes/orders addMaterialRow, 'grams' is what is entered... usually per BATCH.

                            const gramsPerPiece = m.grams / batchPcs;
                            const toDeduct = gramsPerPiece * piecesAdded;

                            if (toDeduct > 0) {
                                // Fetch current spool weight
                                const { data: spool } = await sb.from('materials').select('current_weight').eq('id', m.id).single();
                                if (spool) {
                                    const newW = spool.current_weight - toDeduct;
                                    await sb.from('materials').update({ current_weight: newW }).eq('id', m.id);
                                }
                            }
                        }
                        showToast(`Î‘Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎ±Î½ Ï…Î»Î¹ÎºÎ¬ Î³Î¹Î± ${piecesAdded} Ï„Î¼Ï‡`, 'success');
                    }
                }

                // Reload to refresh UI
                loadData();
            } catch (e) {
                console.error(e);
                showToast("Î£Ï†Î¬Î»Î¼Î±: " + e.message, 'error');
            }
        }
        // Helper to handle manual input change
        function manualProgressUpdate(id, valStr, oldVal, total) {
            let newVal = parseInt(valStr);
            if (isNaN(newVal)) newVal = oldVal;
            if (newVal < 0) newVal = 0;
            if (newVal > total) newVal = total;

            const change = newVal - oldVal;
            if (change === 0) return;

            updateQuickProgress(id, change, oldVal, total);
        }
    </script>
</body>

</html>