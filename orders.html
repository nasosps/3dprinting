<!DOCTYPE html>
<html lang="el">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î Î±ÏÎ±Î³Ï‰Î³Î®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        ::-webkit-scrollbar {
            width: 6px
        }

        ::-webkit-scrollbar-track {
            background: #18181b
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 4px
        }

        input,
        select,
        textarea {
            font-size: 16px !important;
        }

        .custom-dropdown {
            max-height: 250px;
            overflow-y: auto;
            position: absolute;
            z-index: 50;
            width: 100%;
            background: #27272a;
            border: 1px solid #4b5563;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .dropdown-item {
            padding: 12px;
            border-bottom: 1px solid #3f3f46;
            cursor: pointer;
            color: white;
            font-size: 14px;
        }

        .dropdown-item:hover {
            background-color: #3f3f46;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body class="bg-[#18181b] text-white min-h-screen font-sans pb-32">

    <div class="max-w-6xl mx-auto p-4 lg:pt-8 pt-20"> <!-- Added pt-20 for mobile header spacing -->
        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-green-500">Î Î±ÏÎ±Î³Ï‰Î³Î®</h1>
            <button onclick="toggleArchived()" id="toggleBtn"
                class="bg-gray-800 px-4 py-3 rounded-xl border border-gray-700 text-sm font-bold text-gray-300 hover:text-white transition active:scale-95 shadow-md">
                <i class="fas fa-history mr-2"></i>Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ
            </button>
        </div>

        <div id="ordersList" class="space-y-5">
            <div class="text-center text-gray-500 py-10 animate-pulse text-lg">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</div>
        </div>
    </div>

    <button id="addBtn" onclick="openOrderModal()"
        class="fixed bottom-8 right-6 w-16 h-16 bg-green-600 rounded-full flex justify-center items-center shadow-[0_0_25px_rgba(22,163,74,0.6)] hover:scale-110 transition z-30 text-white text-3xl">
        <i class="fas fa-plus"></i>
    </button>

    <div id="orderModal" class="hidden fixed inset-0 bg-black/95 z-50 flex items-start justify-center overflow-y-auto">
        <div
            class="w-full min-h-screen sm:min-h-0 sm:max-w-lg sm:my-10 bg-[#18181b] sm:rounded-2xl sm:border border-gray-700 shadow-2xl flex flex-col relative">

            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-[#202022] sm:rounded-t-2xl">
                <h3 class="text-xl font-bold text-green-400" id="modalTitle">ÎÎ­Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±</h3>
                <button onclick="closeModal()"
                    class="bg-gray-800 w-10 h-10 rounded-full text-gray-400 hover:text-white flex items-center justify-center border border-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 space-y-8 pb-24">
                <input type="hidden" id="editOrderId">

                <div class="space-y-5">
                    <div>
                        <label
                            class="text-sm text-gray-400 uppercase font-bold ml-1 mb-2 block tracking-wider">Î ÎµÎ»Î±Ï„Î·Ï‚</label>
                        <select id="selClient"
                            class="w-full p-4 rounded-xl bg-[#27272a] border border-gray-600 text-white text-lg outline-none focus:border-green-500 shadow-sm"></select>
                    </div>

                    <div>
                        <label
                            class="text-sm text-gray-400 font-bold uppercase ml-1 mb-2 block tracking-wider">Preset</label>
                        <div class="flex gap-3">
                            <select id="selModel"
                                class="w-full p-4 rounded-xl bg-[#27272a] border border-gray-600 text-base outline-none focus:border-green-500 shadow-sm"
                                onchange="applyPreset()">
                                <option value="">-- Î§ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± --</option>
                            </select>
                        </div>
                    </div>

                    <input type="text" id="inpTitle"
                        class="w-full p-4 rounded-xl bg-[#27272a] border border-gray-600 outline-none focus:border-green-500 text-lg font-bold placeholder-gray-500 shadow-sm"
                        placeholder="Î¤Î¯Ï„Î»Î¿Ï‚ ÎˆÏÎ³Î¿Ï…">
                </div>

                <div class="bg-gray-800/30 p-5 rounded-2xl border border-green-900/40">
                    <div class="text-sm text-green-500 font-bold mb-4 uppercase tracking-wider flex items-center gap-2">
                        <i class="fas fa-fill-drip"></i> Î¥Î»Î¹ÎºÎ± & Î§ÏÏ‰Î¼Î±Ï„Î±
                    </div>

                    <div class="grid grid-cols-1 gap-4 mb-4 relative">
                        <div class="relative">
                            <input type="text" id="materialSearch"
                                class="w-full p-4 rounded-xl bg-[#27272a] border border-gray-500 text-white text-lg focus:border-green-500 outline-none shadow-inner"
                                placeholder="ğŸ” Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..." onkeyup="filterMaterialList()"
                                onfocus="filterMaterialList()">
                            <div id="materialDropdown" class="custom-dropdown hidden"></div>
                        </div>
                    </div>

                    <div class="flex gap-4 items-center bg-[#27272a] p-4 rounded-xl border border-gray-600 shadow-lg">
                        <div id="selectedMatInfo" class="flex-grow text-base text-gray-300 italic px-2 font-medium">--
                            Î•Ï€Î¯Î»ÎµÎ¾Îµ --</div>
                        <input type="number" id="addMatGrams" placeholder="Gr"
                            class="w-24 p-3 rounded-lg bg-gray-900 text-xl text-center border border-gray-500 text-white font-bold outline-none focus:border-green-500">
                        <button onclick="addMaterialRow()"
                            class="bg-green-600 w-14 h-12 rounded-lg text-white hover:bg-green-500 transition shadow-lg flex items-center justify-center"><i
                                class="fas fa-plus text-xl"></i></button>
                    </div>
                    <div id="usedMatsList" class="mt-4 space-y-3"></div>
                </div>

                <div class="bg-gray-800/30 p-5 rounded-2xl border border-gray-600/40">
                    <div class="flex justify-between items-center mb-5">
                        <span class="text-base font-bold text-gray-300 uppercase tracking-wider">Batch Setup</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mb-5">
                        <div><label
                                class="text-xs text-gray-400 block text-center uppercase mb-2 font-bold">Î¤ÎµÎ¼/Î Î»Î±Ï„Î¿</label><input
                                type="number" id="batchPcs" value="1"
                                class="w-full p-3 bg-[#27272a] border border-gray-600 text-center rounded-xl text-xl font-bold shadow-inner focus:border-green-500 outline-none"
                                oninput="calcUnit()"></div>
                        <div><label class="text-xs text-gray-400 block text-center uppercase mb-2 font-bold">Total
                                Gr</label><input type="number" id="bGrams" readonly
                                class="w-full p-3 bg-gray-900 border border-gray-700 text-center rounded-xl text-lg text-gray-400 cursor-not-allowed font-mono">
                        </div>
                        <div><label class="text-xs text-gray-400 block text-center uppercase mb-2 font-bold">Total
                                Min</label><input type="number" id="bMins"
                                class="w-full p-3 bg-[#27272a] border border-gray-600 text-center rounded-xl text-lg font-mono focus:border-green-500 outline-none"
                                oninput="calcUnit()"></div>
                    </div>
                    <div
                        class="mt-4 p-4 bg-[#202022] rounded-xl border-2 border-gray-600 border-dashed text-center shadow-inner">
                        <div class="text-xs text-gray-500 uppercase mb-2 font-bold tracking-widest">Î‘ÎÎ‘ Î¤Î•ÎœÎ‘Î§Î™ÎŸ (UNIT)
                        </div>
                        <div class="flex justify-center items-center gap-8 text-2xl font-mono font-bold">
                            <span class="text-white"><span id="resGrams">0.00</span><span
                                    class="text-sm text-gray-500 ml-1">g</span></span>
                            <span class="text-gray-600 text-3xl font-light">|</span>
                            <span class="text-white"><span id="resMins">0.00</span><span
                                    class="text-sm text-gray-500 ml-1">min</span></span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800/30 p-5 rounded-2xl border border-indigo-900/30">
                    <div class="text-sm text-indigo-400 font-bold mb-3 uppercase tracking-wider">Extras</div>
                    <div class="flex gap-3">
                        <select id="addExtSel"
                            class="flex-grow p-4 rounded-xl bg-[#27272a] text-lg border border-gray-600 text-gray-300 outline-none focus:border-indigo-500"></select>
                        <button onclick="addExtraRow()"
                            class="bg-indigo-600 w-14 h-14 rounded-xl text-white hover:bg-indigo-500 transition shadow-lg flex items-center justify-center"><i
                                class="fas fa-plus text-xl"></i></button>
                    </div>
                    <div id="usedExtList" class="mt-4 space-y-3"></div>
                </div>

                <div class="bg-[#202022] p-6 rounded-3xl border border-gray-600 shadow-2xl">
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div><label
                                class="text-xs text-gray-400 font-bold uppercase block mb-2 tracking-wider">Î–Î·Ï„Î¿Ï…Î¼ÎµÎ½Î±</label><input
                                type="number" id="inpQty" value="1"
                                class="w-full p-4 bg-[#18181b] border border-gray-600 text-center text-white font-bold rounded-2xl focus:border-green-500 outline-none text-3xl shadow-inner"
                                oninput="recalc()"></div>
                        <div><label class="text-xs text-green-400 font-bold uppercase block mb-2 tracking-wider">Î¤Î¹Î¼Î·
                                (â‚¬)</label><input type="number" id="inpUnitPrice"
                                class="w-full p-4 bg-[#18181b] border border-green-500 text-center text-white font-bold rounded-2xl focus:ring-2 ring-green-500/50 outline-none text-3xl shadow-inner"
                                placeholder="0.00" oninput="recalc()"></div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 text-center mb-6">
                        <div class="bg-[#18181b] p-4 rounded-2xl border border-gray-700 flex flex-col justify-center">
                            <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">ÎšÎŸÎ£Î¤ÎŸÎ£</div>
                            <div class="text-xl font-extrabold text-red-400"><span id="resTotalCost">0.00</span>â‚¬</div>
                        </div>
                        <div class="bg-[#18181b] p-4 rounded-2xl border border-gray-700 flex flex-col justify-center">
                            <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">ÎšÎ•Î¡Î”ÎŸÎ£</div>
                            <div class="text-xl font-extrabold text-green-400"><span id="resNetProfit">0.00</span>â‚¬
                            </div>
                        </div>
                        <div class="bg-[#18181b] p-4 rounded-2xl border border-gray-700 flex flex-col justify-center">
                            <div class="text-[10px] text-gray-500 uppercase font-bold mb-1">ROI</div>
                            <div class="text-xl font-extrabold text-yellow-500"><span id="resMargin">0</span>%</div>
                        </div>
                    </div>

                    <div class="text-center pt-4 border-t border-gray-700">
                        <div class="text-xs text-gray-500 uppercase font-bold mb-1 tracking-[0.2em]">Î£Î¥ÎÎŸÎ›Î™ÎšÎŸÎ£ Î¤Î–Î™Î¡ÎŸÎ£
                        </div>
                        <div class="text-6xl font-extrabold text-white tracking-tighter drop-shadow-lg"><span
                                id="resTotalPrice">0.00</span><span class="text-2xl text-gray-500 ml-1">â‚¬</span></div>
                    </div>
                </div>

                <button onclick="saveOrder()"
                    class="w-full bg-green-600 py-5 rounded-2xl font-bold hover:bg-green-500 transition shadow-xl text-xl text-white uppercase tracking-wider mb-8 flex items-center justify-center gap-3">
                    <i class="fas fa-check text-2xl"></i> Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…ÏƒÎ·
                </button>
            </div>
        </div>
    </div>

    <div id="logModal" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
        <div class="bg-[#27272a] p-6 rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl">
            <h3 class="text-white font-bold mb-2 text-center text-xl">Log Print</h3>
            <p id="logInfo" class="text-sm text-gray-400 text-center mb-6"></p>
            <input type="number" id="logPcs" placeholder="Î¤ÎµÎ¼Î¬Ï‡Î¹Î±;"
                class="w-full p-4 bg-gray-900 border border-green-500 text-center text-white font-bold rounded-xl text-3xl outline-none mb-6">
            <div class="flex gap-4">
                <button onclick="document.getElementById('logModal').classList.add('hidden')"
                    class="flex-1 bg-gray-700 py-3 rounded-xl font-bold text-lg">Î†ÎºÏ…ÏÎ¿</button>
                <button onclick="submitProductionLog()"
                    class="flex-1 bg-green-600 py-3 rounded-xl font-bold hover:bg-green-500 text-lg">OK</button>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // Global Error Handler
        window.onerror = function (message, source, lineno, colno, error) {
            alert("JS Error: " + message + "\nLine: " + lineno);
        };

        let mats = [], extras = [], currentMats = [], currentExtras = [], loadedPresets = {}, activeOrderId = null, selectedSpool = null;
        let showArchived = false;
        let customersMap = {};

        renderSidebar('orders');

        async function init() {
            try {
                // Fetch Data
                const { data: mData } = await sb.from('materials').select('*');
                if (mData) mats = mData;

                const { data: eData } = await sb.from('accessories').select('*');
                if (eData) extras = eData;

                const sel = document.getElementById('addExtSel'); sel.innerHTML = "";
                extras.forEach(e => sel.innerHTML += `<option value="${e.id}">${e.name} (${e.cost}â‚¬)</option>`);

                const { data: pData } = await sb.from('print_models').select('*');
                const mSel = document.getElementById('selModel');
                mSel.innerHTML = '<option value="">-- Preset --</option>';
                if (pData) pData.forEach(p => {
                    loadedPresets[p.id] = p;
                    mSel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });

                const { data: customers } = await sb.from('customers').select('id, name').order('name');
                const cSel = document.getElementById('selClient'); cSel.innerHTML = "";
                if (customers) {
                    customers.forEach(c => {
                        customersMap[c.id] = c.name;
                        cSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                    });
                }

                document.addEventListener('click', function (e) {
                    const dd = document.getElementById('materialDropdown');
                    const inp = document.getElementById('materialSearch');
                    if (dd && !dd.contains(e.target) && e.target !== inp) dd.classList.add('hidden');
                });

                loadOrders();
            } catch (e) {
                console.error("INIT ERROR:", e);
                alert("Î£Ï†Î¬Î»Î¼Î± ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·Ï‚: " + e.message);
            }
        }

        // Start App
        setTimeout(init, 500);

        function toggleArchived() {
            showArchived = !showArchived;
            const btn = document.getElementById('toggleBtn');
            if (showArchived) {
                btn.innerHTML = '<i class="fas fa-eye-slash mr-2"></i>ÎšÏÏÏˆÎµ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ';
                btn.classList.add('bg-blue-900', 'text-blue-200');
            } else {
                btn.innerHTML = '<i class="fas fa-history mr-2"></i>Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ';
                btn.classList.remove('bg-blue-900', 'text-blue-200');
            }
            loadOrders();
        }

        async function loadOrders() {
            const list = document.getElementById('ordersList');
            let query = sb.from('orders').select('*').order('created_at', { ascending: false });
            if (!showArchived) query = query.neq('status', 'archived');

            const { data: orders, error } = await query;
            if (error) { list.innerHTML = 'Error: ' + error.message; return; }
            list.innerHTML = "";
            if (!orders || orders.length === 0) { list.innerHTML = '<div class="text-center text-gray-600 text-lg py-10">ÎšÎ±Î½Î­Î½Î± Î±Ï€Î¿Ï„Î­Î»ÎµÏƒÎ¼Î±</div>'; return; }

            orders.forEach(o => {
                const progress = Math.min(100, Math.round((o.completed_pieces / o.total_pieces) * 100)) || 0;
                const isDone = progress >= 100 && o.status !== 'archived';
                const isArchived = o.status === 'archived';
                const dateStr = o.created_at ? new Date(o.created_at).toLocaleDateString() : '-';
                const clientName = customersMap[o.client_id] || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿Ï‚';

                let buttons = '';

                if (!isArchived) {
                    let logOrArchiveBtn = '';
                    if (!isDone) {
                        logOrArchiveBtn = `<button onclick="openLogModal('${o.id}', ${o.total_pieces}, ${o.completed_pieces})" class="bg-gray-800 text-green-400 px-6 py-3 rounded-xl font-bold border border-green-500/30 hover:bg-green-900 transition flex-[2] flex justify-center items-center gap-2 shadow-lg"><i class="fas fa-print"></i> LOG PRINT</button>`;
                    } else {
                        logOrArchiveBtn = `<button onclick="archiveOrder('${o.id}')" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-500 transition flex-[2] animate-pulse shadow-lg">Î‘Î¡Î§Î•Î™ÎŸÎ˜Î•Î¤Î—Î£Î—</button>`;
                    }

                    buttons = `
                        <button onclick="editOrder('${o.id}')" class="bg-gray-800 text-blue-400 px-4 py-3 rounded-xl font-bold border border-gray-600 hover:bg-gray-700 transition flex-1 sm:flex-none flex justify-center"><i class="fas fa-pen text-xl"></i></button>
                        ${logOrArchiveBtn}
                    `;
                }

                list.innerHTML += `
                <div class="bg-[#27272a] p-5 rounded-2xl border ${isArchived ? 'border-gray-800 opacity-60' : (isDone ? 'border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.1)]' : 'border-gray-700')} relative group">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="text-xs text-gray-500 mb-1 font-mono">${dateStr} â€¢ ${clientName}</div>
                            <div class="font-bold text-xl text-white mb-1 leading-tight">${o.description}</div>
                            <div class="text-sm ${isDone ? 'text-green-400 font-bold' : 'text-gray-400'}">${o.completed_pieces} / ${o.total_pieces} Ï„ÎµÎ¼.</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-green-400">${(o.sale_price || 0).toFixed(2)}â‚¬</div>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-800 rounded-full h-3 overflow-hidden shadow-inner mb-4">
                        <div class="bg-green-500 h-full transition-all duration-700 ease-out" style="width: ${progress}%"></div>
                    </div>

                    <div class="flex gap-3 justify-end">
                        ${buttons}
                        <button onclick="deleteRow('orders', '${o.id}', loadOrders)" class="bg-gray-800 text-red-500 px-4 py-3 rounded-xl font-bold border border-gray-600 hover:bg-gray-700 transition flex-1 sm:flex-none flex justify-center"><i class="fas fa-trash text-xl"></i></button>
                    </div>
                </div>`;
            });
        }

        // --- MODAL FUNCTIONS ---
        function openOrderModal() {
            document.getElementById('editOrderId').value = "";
            document.getElementById('modalTitle').innerText = "ÎÎ­Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±";
            resetModalFields();
            document.getElementById('orderModal').classList.remove('hidden');
        }

        async function editOrder(id) {
            try {
                const { data: o, error } = await sb.from('orders').select('*').eq('id', id).single();
                if (error) throw error;

                if (o) {
                    document.getElementById('editOrderId').value = o.id;
                    document.getElementById('modalTitle').innerText = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±";
                    document.getElementById('selClient').value = o.client_id || "";
                    document.getElementById('inpTitle').value = o.description || "";
                    document.getElementById('inpQty').value = o.total_pieces || 1;
                    document.getElementById('inpUnitPrice').value = o.unit_price || 0;
                    document.getElementById('batchPcs').value = o.batch_pcs || 1;
                    document.getElementById('bMins').value = o.batch_mins || 0;

                    currentMats = o.materials_used || [];
                    currentExtras = o.extras_used || [];
                    renderRows();
                    calcUnit();

                    document.getElementById('orderModal').classList.remove('hidden');
                }
            } catch (e) {
                alert("Error opening edit: " + e.message);
            }
        }

        function resetModalFields() {
            currentMats = []; currentExtras = [];
            document.getElementById('inpTitle').value = "";
            document.getElementById('inpQty').value = "1";
            document.getElementById('inpUnitPrice').value = "";
            document.getElementById('batchPcs').value = "1";
            document.getElementById('bGrams').value = "0";
            document.getElementById('bMins').value = "0";
            renderRows();
            calcUnit();
        }

        function closeModal() { document.getElementById('orderModal').classList.add('hidden'); }

        async function saveOrder() {
            try {
                const id = document.getElementById('editOrderId').value;
                const calcData = recalc();
                const data = {
                    client_id: document.getElementById('selClient').value,
                    description: document.getElementById('inpTitle').value,
                    total_pieces: parseFloat(document.getElementById('inpQty').value),
                    unit_price: parseFloat(document.getElementById('inpUnitPrice').value),
                    sale_price: calcData.totalPrice,
                    total_cost: calcData.totalCost,
                    batch_pcs: parseFloat(document.getElementById('batchPcs').value),
                    batch_grams: parseFloat(document.getElementById('bGrams').value),
                    batch_mins: parseFloat(document.getElementById('bMins').value),
                    materials_used: currentMats,
                    extras_used: currentExtras,
                    status: 'active'
                };

                if (id) {
                    await sb.from('orders').update(data).eq('id', id);
                } else {
                    data.completed_pieces = 0;
                    await sb.from('orders').insert(data);
                }
                closeModal();
                loadOrders();
            } catch (e) {
                alert("Save Error: " + e.message);
            }
        }

        // --- SHARED LOGIC ---
        function filterMaterialList() {
            const val = document.getElementById('materialSearch').value.toUpperCase();
            const dd = document.getElementById('materialDropdown');
            dd.innerHTML = ""; dd.classList.remove('hidden');

            const matches = mats.filter(m => m.brand.includes(val) || m.type.includes(val) || m.color.includes(val));
            const uniqueOptions = {};
            matches.forEach(m => {
                const key = `${m.brand} ${m.type} ${m.color}`;
                if (!uniqueOptions[key] || uniqueOptions[key].current_weight < m.current_weight) uniqueOptions[key] = m;
            });

            const finalList = Object.values(uniqueOptions);
            if (finalList.length === 0) { dd.innerHTML = '<div class="p-3 text-gray-500 italic text-center">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ</div>'; return; }

            finalList.forEach(m => {
                const div = document.createElement('div'); div.className = 'dropdown-item flex justify-between items-center';
                div.innerHTML = `<span><span class="font-bold text-white text-lg">${m.color}</span> <span class="text-gray-400 text-sm ml-2">${m.brand} ${m.type}</span></span><span class="text-green-500 font-mono text-sm">${Math.round(m.current_weight)}g</span>`;
                div.onclick = function () { selectMaterial(m); };
                dd.appendChild(div);
            });
        }

        function selectMaterial(m) {
            selectedSpool = m;
            document.getElementById('selectedMatInfo').innerText = `${m.brand} ${m.type} ${m.color}`;
            document.getElementById('selectedMatInfo').className = "flex-grow text-lg text-green-400 font-bold px-2";
            document.getElementById('materialSearch').value = "";
            document.getElementById('materialDropdown').classList.add('hidden');
            document.getElementById('addMatGrams').focus();
        }

        function applyPreset() {
            const id = document.getElementById('selModel').value; if (!id || !loadedPresets[id]) return;
            const m = loadedPresets[id]; document.getElementById('inpTitle').value = m.name;
            document.getElementById('batchPcs').value = m.batch_pcs || 1;
            document.getElementById('bMins').value = m.batch_mins || 0;
            document.getElementById('inpUnitPrice').value = m.unit_price || "";
            currentMats = m.materials ? JSON.parse(JSON.stringify(m.materials)) : [];
            renderRows();
        }

        function addMaterialRow() {
            if (!selectedSpool) return showToast("Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï…Î»Î¹ÎºÏŒ!", 'error');
            const g = parseFloat(document.getElementById('addMatGrams').value); if (!g) return;
            currentMats.push({ id: selectedSpool.id, name: selectedSpool.name, price: selectedSpool.price, grams: g });
            document.getElementById('addMatGrams').value = "";
            document.getElementById('selectedMatInfo').innerText = "-- Î•Ï€Î¯Î»ÎµÎ¾Îµ --";
            document.getElementById('selectedMatInfo').className = "flex-grow text-base text-gray-300 italic px-2 font-medium";
            selectedSpool = null;
            renderRows();
        }

        function addExtraRow() {
            const id = document.getElementById('addExtSel').value; if (!id) return;
            const e = extras.find(x => x.id === id); currentExtras.push({ id: e.id, name: e.name, cost: e.cost }); renderRows();
        }

        function renderRows() {
            document.getElementById('usedMatsList').innerHTML = currentMats.map((m, i) => `
                <div class="flex justify-between items-center text-sm bg-[#18181b] p-3 rounded-xl border border-gray-700 shadow-sm"><span class="text-gray-300">${m.name} <span class="text-green-500 font-bold ml-1 text-lg">${m.grams}g</span></span><button onclick="currentMats.splice(${i},1);renderRows()" class="text-red-400 bg-gray-800 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button></div>`).join('');
            document.getElementById('usedExtList').innerHTML = currentExtras.map((e, i) => `
                <div class="flex justify-between items-center text-sm bg-[#18181b] p-3 rounded-xl border border-gray-700 shadow-sm"><span class="text-gray-300">${e.name} <span class="text-indigo-500 font-bold ml-1 text-lg">${e.cost}â‚¬</span></span><button onclick="currentExtras.splice(${i},1);renderRows()" class="text-red-400 bg-gray-800 w-8 h-8 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button></div>`).join('');
            let sumG = 0; currentMats.forEach(m => sumG += m.grams); document.getElementById('bGrams').value = sumG; calcUnit();
        }

        function calcUnit() {
            const p = parseFloat(document.getElementById('batchPcs').value) || 1;
            const g = parseFloat(document.getElementById('bGrams').value) || 0;
            const m = parseFloat(document.getElementById('bMins').value) || 0;
            document.getElementById('resGrams').innerText = (g / p).toFixed(2);
            document.getElementById('resMins').innerText = (m / p).toFixed(2);
            recalc();
        }

        function recalc() {
            const qty = parseFloat(document.getElementById('inpQty').value) || 1;
            const uprice = parseFloat(document.getElementById('inpUnitPrice').value) || 0;
            const bPcs = parseFloat(document.getElementById('batchPcs').value) || 1;

            let mCostBatch = 0; currentMats.forEach(m => mCostBatch += (m.grams * (m.price / 1000)));
            let mCostUnit = mCostBatch / bPcs;

            let eCostUnit = 0; currentExtras.forEach(e => eCostUnit += e.cost);
            const unitMins = parseFloat(document.getElementById('resMins').innerText) || 0;
            const powerCostUnit = (unitMins / 60) * 0.75;

            const totalCostUnit = mCostUnit + eCostUnit + powerCostUnit;
            const totalCostOrder = totalCostUnit * qty;
            const totalPriceOrder = uprice * qty;
            const netProfit = totalPriceOrder - totalCostOrder;

            document.getElementById('resTotalCost').innerText = totalCostOrder.toFixed(2);
            document.getElementById('resTotalPrice').innerText = totalPriceOrder.toFixed(2);
            document.getElementById('resNetProfit').innerText = netProfit.toFixed(2);
            let roi = totalCostOrder > 0 ? (netProfit / totalCostOrder) * 100 : 0;
            document.getElementById('resMargin').innerText = Math.round(roi);

            return { totalCost: totalCostOrder, totalPrice: totalPriceOrder };
        }

        async function archiveOrder(id) {
            if (!confirm("Î‘ÏÏ‡ÎµÎ¹Î¿Î¸Î­Ï„Î·ÏƒÎ·;")) return;
            await sb.from('orders').update({ status: 'archived', archive_date: new Date() }).eq('id', id);
            loadOrders();
        }

        function openLogModal(id, total, completed) {
            activeOrderId = id;
            document.getElementById('logInfo').innerText = `Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: ${total - completed} Ï„ÎµÎ¼.`;
            document.getElementById('logPcs').value = "";
            document.getElementById('logModal').classList.remove('hidden');
            document.getElementById('logPcs').focus();
        }

        async function submitProductionLog() {
            const pcs = parseFloat(document.getElementById('logPcs').value);
            if (!pcs || pcs <= 0) return showToast("Î’Î¬Î»Îµ Î±ÏÎ¹Î¸Î¼ÏŒ!", 'error');

            const { data: order } = await sb.from('orders').select('*').eq('id', activeOrderId).single();
            if (!order) return;

            const newCompleted = (order.completed_pieces || 0) + pcs;
            const newStatus = newCompleted >= order.total_pieces ? 'completed' : 'active';

            await sb.from('orders').update({ completed_pieces: newCompleted, status: newStatus }).eq('id', activeOrderId);

            if (order.materials_used && Array.isArray(order.materials_used)) {
                for (const m of order.materials_used) {
                    const deduct = (m.grams / (order.batch_pcs || 1)) * pcs;
                    const { data: matData } = await sb.from('materials').select('current_weight').eq('id', m.id).single();
                    if (matData) {
                        await sb.from('materials').update({ current_weight: matData.current_weight - deduct }).eq('id', m.id);
                    }
                }
            }
            document.getElementById('logModal').classList.add('hidden');
            loadOrders();
        }
    </script>
</body>

</html>